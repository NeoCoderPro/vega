<!DOCTYPE HTML>
<html>
  <head>
    <title>Vega Test</title>
    <script src="../../build/vega.js"></script>
    <style>
      body { margin: 10px; font: 14px Helvetica Neue; }
    </style>
  </head>
  <body>
    <div id="view"></div>
    <script>
var values = [
  {"x": 0,  "y": 28},
  {"x": 1,  "y": 43},
  {"x": 2,  "y": 81},
  {"x": 3,  "y": 56},
  {"x": 4,  "y": 38},
  {"x": 5,  "y": 73},
  {"x": 6,  "y": 62},
  {"x": 7,  "y": 24}
];

var runtimeSpec = {
  operators: [
    {id:0, type:'Operator', value:200, signal:'width'},
    {id:1, type:'Operator', value:100, signal:'height'},
    {id:2, type:'Operator', value:null, signal:'root'},
    {id:3, type:'Collect', data: {__marks__:['input', 'output']}},
    {id:4, type:'Encode', params:{
      encoders: {
        $encode: {
          update: {$expr: 'var o=item;o.width=_.width,o.height=_.height;return(1);'}
        }
      },
      width: {$ref:0}, height: {$ref:1}, pulse: {$ref:3}
    }},

    {id:5, type:'Collect', value:values},
    {id:6, type:'DataJoin', params:{pulse:{$ref:5}}},
    {id:7, type:'Collect', params:{pulse:{$ref:6}}},
    {id:8, type:'Mark', params: {
      markdef: {marktype: 'rect'},
      scenepath: [0],
      pulse: {$ref:7}
    }},
    {id:9, type:'Encode', params:{
      encoders: {
        $encode: {
          enter: {
            $expr: 'var o=item,t=o.datum;o.x=25*t.x;o.y=0;o.height=t.y;o.width=24;o.cornerRadius=4;return(1);',
            $fields: ['x', 'y']
          },
          update: {$expr: 'var o=item;o.fill="steelblue";return(1);'},
          hover: {$expr: 'var o=item;o.fill="fuchsia";return(1);'}
        }
      },
      pulse: {$ref:8}
    }},
    {id:10, type:'Bound', params:{mark:{$ref:8}, pulse:{$ref:9}}},
    {id:11, type:'Sieve', params:{pulse: {$ref:10}}},
    {id:12, type:'Render', params:{pulse: {$ref:10}}},

    {id:13, type:'Bound', params:{mark:{$ref:2}, pulse:{$ref:4}, children:[{$ref:11}]}},
    {id:14, type:'Sieve', params:{pulse: {$ref:13}}, data: {__marks__:['values']}},
    {id:15, type:'Render', params:{pulse: {$ref:13}}},
  ],

  streams: [
    {id:100, source:'view', type:'mouseover', filter:'event.item'},
    {id:101, source:'view', type:'mouseout', filter:'event.item'}
  ],

  updates: [
    {
      source: 100,
      target: {$expr: 'event.item.mark.source'},
      update: {$expr: 'event.dataflow.changeset().encode(event.item, "hover")'}
    },
    {
      source: 101,
      target: {$expr: 'event.item.mark.source'},
      update: {$expr: 'event.dataflow.changeset().encode(event.item, "update")'}
    }
  ]
};

var view = new vega.View(runtimeSpec);

view.renderer('canvas')
  .initialize(document.querySelector('#view'))
  .run();
    </script>
  </body>
  </html>