<!DOCTYPE HTML>
<html>
  <head>
    <title>Vega Pan/Zoom Test</title>
    <script src="../../build/vega.js"></script>
    <style>
      body { margin: 0px; font: 14px Helvetica Neue; }
    </style>
  </head>
  <body>
    <div id="view"></div>
    <script>
var values = [],
    sample = vega.normal(0.5, 0.2);
for (var i=0; i<500; ++i) {
  values.push({u: sample(), v: sample()});
}

var width = window.innerWidth,
    height = window.innerHeight;

var runtimeSpec = {
  operators: [
    {id:'root',   value:null,   root:true},
    {id:'width',  value:width,  signal:'width'},
    {id:'height', value:height, signal:'height'},
    {id:'padding', type:'Operator', value:{left:5,top:5,right:5,bottom:5}, signal:'padding'},

    {
      id:'dim',
      update: 'Math.min(_.w, _.h)',
      params: {w:{$ref:'width'}, h:{$ref:'height'}}
    },
    {
      id:'offset',
      update: '(Math.max(_.w, _.h) - Math.min(_.w, _.h)) / 2',
      params: {w:{$ref:'width'}, h:{$ref:'height'}}
    },
    {
      id:'xrange',
      update: '[_.x, _.x + _.w]',
      params: {w:{$ref:'dim'}, x:{$ref:'offset'}}
    },
    {
      id:'yrange',
      update: '[_.h, 0]',
      params: {h:{$ref:'dim'}}
    },

    {id:'pdata',  type:'Collect', value:values, data: {points:['input', 'output']}},
    {id:'xext',   type:'Extent', params:{field:{$field:'u'}, pulse:{$ref:'pdata'}}},
    {id:'yext',   type:'Extent', params:{field:{$field:'v'}, pulse:{$ref:'pdata'}}},

    {id:'anchor', value:[0,0], signal:'anchor'},
    {id:'down',   value:null,  signal:'down'},
    {id:'zoom',   value:1,     signal:'zoom'},
    {id:'dist1',  value:0,     signal:'dist1'},
    {id:'dist2',  value:0,     signal:'dist2'},
    {id:'delta',  value:[0,0], signal:'delta'},
    {id:'xcur',   value:null,  signal:'xcur'},
    {id:'ycur',   value:null,  signal:'ycur'},
    {id:'size',   value:10,    signal:'size'},

    {id:'xdom',   update:'_.x', params:{x:{$ref:'xext'}}, react:false, signal:'xdom'},
    {id:'ydom',   update:'_.y', params:{y:{$ref:'yext'}}, react:false, signal:'ydom'},
    {id:'xscale', type:'Scale', params:{domain:{$ref:'xdom'}, range:{$ref:'xrange'}}},
    {id:'yscale', type:'Scale', params:{domain:{$ref:'ydom'}, range:{$ref:'yrange'}}},

    {id:'marks', type:'Collect', data: {root:['input', 'output']}},
    {id:'menc',  type:'Encode', params:{
      encoders: {
        $encode: {
          update: {$expr: 'var o=item;o.width=_.width,o.height=_.height;return(1);'}
        }
      },
      width: {$ref:'width'},
      height: {$ref:'height'},
      pulse: {$ref:'marks'}
    } },

    {id:'pjoin', type:'DataJoin', params:{pulse:{$ref:'pdata'}}},
    {id:'pcoll', type:'Collect', params:{pulse:{$ref:'pjoin'}}},
    {id:'pmark', type:'Mark', params: {
      markdef: {marktype: 'symbol'},
      scenepath: [0],
      pulse: {$ref:'pcoll'}
    } },
    {id:'penc',  type:'Encode', params:{
      encoders: {
        $encode: {
          enter: { $expr: 'item.fillOpacity=0.6;item.fill="steelblue";return(1);', },
          update: {
            $expr: 'var o=item,d=o.datum;o.x=_.xscale(d.u);o.y=_.yscale(d.v);item.size=_.size;return(1);',
            $fields: ['u', 'v']
          },
          hover: { $expr: 'item.fill="firebrick";return(1);' },
          leave: { $expr: 'item.fill="steelblue";return(1);' }
        }
      },
      xscale: {$ref:'xscale'},
      yscale: {$ref:'yscale'},
      size:   {$ref:'size'},
      pulse:  {$ref:'pmark'}
    } },
    {id:'pbound', type:'Bound', params:{mark:{$ref:'pmark'}, pulse:{$ref:'penc'}}},
    {id:'psieve', type:'Sieve', params:{pulse: {$ref:'pbound'}}},
    {id:'prend',  type:'Render', params:{pulse: {$ref:'pbound'}}},

    {id:'mbound', type:'Bound', params:{mark:{$ref:'root'}, pulse:{$ref:'menc'}, children:[{$ref:'psieve'}]}},
    {id:'msieve', type:'Sieve', params:{pulse: {$ref:'mbound'}}, data: {root:['values']}},
    {id:'mrend',  type:'Render', params:{pulse: {$ref:'mbound'}}},
  ],

  streams: [
    {id:'hover', source:'view', type:'mouseover', filter:'event.item'},
    {id:'leave', source:'view', type:'mouseout', filter:'event.item'},
    {id:'mousedown', source:'view', type:'mousedown'},
    {id:'mouseup', source:'window', type:'mouseup'},
    {id:'mousemove', source:'window', type:'mousemove'},
    {id:'mousedrag', stream:'mousemove', between:['mousedown', 'mouseup']},
    {id:'touchstart', source:'view', type:'touchstart', filter:'event.touches.length===1'},
    {id:'pinchstart', source:'view', type:'touchstart', filter:'event.touches.length===2'},
    {id:'touchmove', source:'view', type:'touchmove', filter:'event.touches.length===1', consume:true},
    {id:'pinchmove', source:'view', type:'touchmove', filter:'event.touches.length===2', consume:true},
    {id:'touchend', source:'view', type:'touchend'},
    {id:'start', merge:['mousedown', 'touchstart'], throttle:500},
    {id:'reset', merge:['start', 'touchend']},
    {id:'drag', merge:['mousedrag', 'touchmove'], consume:true},
    {id:'wheel', source:'window', type:'wheel', consume:true},
    {id:'resize', source:'window', type:'resize', debounce:200}
  ],

  updates: [
    // HOVER
    {
      source: 'hover',
      target: {$expr: 'event.item.mark.source'},
      update: {$expr: 'event.dataflow.changeset().encode(event.item, "hover")'}
    },
    {
      source: 'leave',
      target: {$expr: 'event.item.mark.source'},
      update: {$expr: 'event.dataflow.changeset().encode(event.item, "leave")'}
    },

    // DRAG-TO-PAN
    {
      source: 'touchend', target: 'down',
      update: {$expr: 'null'}
    },
    {
      source: 'start', target: 'down',
      update: {$expr: '[event.viewX, event.viewY]'}
    },
    {
      source: 'reset', target: 'xcur',
      update: {$expr: '_.x.slice()', $params: {x:{$ref:'xdom'}}}
    },
    {
      source: 'reset', target: 'ycur',
      update: {$expr: '_.y.slice()', $params: {y:{$ref:'ydom'}}}
    },
    {
      source: 'drag', target: 'delta',
      update: {
        $expr: '_.p ? [_.p[0] - event.viewX, event.viewY - _.p[1]] : [0,0]',
        $params: {p:{$ref:'down'}}
      }
    },

    // SCROLL-TO-ZOOM
    {
      source: 'mousemove', target: 'anchor',
      update: {
        $expr: '[_.xscale.invert(event.viewX), _.yscale.invert(event.viewY)]',
        $params: {xscale:{$ref:'xscale'}, yscale:{$ref:'yscale'}}
      }
    },
    {
      source: 'wheel', target: 'zoom',
      update: {$expr: 'Math.pow(1.001, event.deltaY*Math.pow(16, event.deltaMode))'}
    },

    // PINCH-TO-ZOOM
    {
      source: 'pinchstart', target: 'anchor',
      update: {
        $expr: '[(_.x[0] + _.x[1])/2, (_.y[0] + _.y[1])/2]',
        $params: {x:{$ref:'xdom'}, y:{$ref:'ydom'}}
      }
    },
    {
      source: 'pinchstart', target: 'dist1',
      update: {
        $expr: 'Math.sqrt('
          + 'Math.pow(event.touches[0].clientX - event.touches[1].clientX, 2) + '
          + 'Math.pow(event.touches[0].clientY - event.touches[1].clientY, 2))'
      }
    },
    {
      source: 'pinchmove', target: 'dist2',
      update: {
        $expr: 'Math.sqrt('
          + 'Math.pow(event.touches[0].clientX - event.touches[1].clientX, 2) + '
          + 'Math.pow(event.touches[0].clientY - event.touches[1].clientY, 2))'
      }
    },
    {
      source: 'dist2', target: 'zoom',
      update: {
        $expr: '_.d1 / _.d2',
        $params: {d1:{$ref:'dist1'}, d2:{$ref:'dist2'}}
      }
    },
    {
      source: 'dist2', target: 'dist1',
      update: {
        $expr: '_.d2',
        $params: {d2:{$ref:'dist2'}}
      }
    },

    // UPDATE SCALE DOMAINS ON ZOOM
    {
      source: 'zoom', target: 'xdom',
      update: {
        $expr: '[(_.x[0] - _.a[0]) * _.zoom + _.a[0], (_.x[1] - _.a[0]) * _.zoom + _.a[0]]',
        $params: {x:{$ref:'xdom'}, a:{$ref:'anchor'}, zoom:{$ref:'zoom'}}
      }
    },
    {
      source: 'zoom', target: 'ydom',
      update: {
        $expr: '[(_.y[0] - _.a[1]) * _.zoom + _.a[1], (_.y[1] - _.a[1]) * _.zoom + _.a[1]]',
        $params: {y:{$ref:'ydom'}, a:{$ref:'anchor'}, zoom:{$ref:'zoom'}}
      }
    },

    // UPDATE SCALE DOMAINS ON PAN
    {
      source: 'delta', target: 'xdom',
      update: {
        $expr: '[_.x[0] + (_.x[1]-_.x[0]) * _.d[0] / _.w, _.x[1] + (_.x[1]-_.x[0]) * _.d[0] / _.w]',
        $params: {x:{$ref:'xcur'}, d:{$ref:'delta'}, w:{$ref:'dim'}}
      }
    },
    {
      source: 'delta', target: 'ydom',
      update: {
        $expr: '[_.y[0] + (_.y[1]-_.y[0]) * _.d[1] / _.h, _.y[1] + (_.y[1]-_.y[0]) * _.d[1] / _.h]',
        $params: {y:{$ref:'ycur'}, d:{$ref:'delta'}, h:{$ref:'dim'}}
      }
    },

    // MODIFY POINT SIZE
    {
      source: 'xdom', target: 'size',
      update: {
        $expr: 'Math.min(1000, Math.max(1, 20 / (_.x[1] - _.x[0])))',
        $params: {x:{$ref:'xdom'}}
      }
    },

    // WINDOW RESIZE
    {
      source: 'resize', target: 'width',
      update: {$expr: 'window.innerWidth'}
    },
    {
      source: 'resize', target: 'height',
      update: {$expr: 'window.innerHeight'}
    }
  ]
};

var view = new vega.View(runtimeSpec)
  .initialize(document.querySelector('#view'))
  .run();
    </script>
  </body>
  </html>