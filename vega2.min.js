!function(a,b){if("function"==typeof define&&define.amd)define(["d3","topojson"],b);else if("object"==typeof exports)module.exports=b(require("d3"),require("topojson"));else{var c="undefined"==typeof topojson?null:topojson;a.vg=b(d3,c)}}(this,function(a,b){var d,e,f;return function(a){function b(a,b){return u.call(a,b)}function c(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=b&&b.split("/"),o=s.map,p=o&&o["*"]||{};if(a&&"."===a.charAt(0))if(b){for(a=a.split("/"),g=a.length-1,s.nodeIdCompat&&w.test(a[g])&&(a[g]=a[g].replace(w,"")),a=n.slice(0,n.length-1).concat(a),k=0;k<a.length;k+=1)if(m=a[k],"."===m)a.splice(k,1),k-=1;else if(".."===m){if(1===k&&(".."===a[2]||".."===a[0]))break;k>0&&(a.splice(k-1,2),k-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((n||p)&&o){for(c=a.split("/"),k=c.length;k>0;k-=1){if(d=c.slice(0,k).join("/"),n)for(l=n.length;l>0;l-=1)if(e=o[n.slice(0,l).join("/")],e&&(e=e[d])){f=e,h=k;break}if(f)break;!i&&p&&p[d]&&(i=p[d],j=k)}!f&&i&&(f=i,h=j),f&&(c.splice(0,h,f),a=c.join("/"))}return a}function g(b,c){return function(){var d=v.call(arguments,0);return"string"!=typeof d[0]&&1===d.length&&d.push(null),n.apply(a,d.concat([b,c]))}}function h(a){return function(b){return c(b,a)}}function i(a){return function(b){q[a]=b}}function j(c){if(b(r,c)){var d=r[c];delete r[c],t[c]=!0,m.apply(a,d)}if(!b(q,c)&&!b(t,c))throw new Error("No "+c);return q[c]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice,w=/\.js$/;o=function(a,b){var d,e=k(a),f=e[0];return a=e[1],f&&(f=c(f,b),d=j(f)),f?a=d&&d.normalize?d.normalize(a,h(b)):c(a,b):(a=c(a,b),e=k(a),f=e[0],a=e[1],f&&(d=j(f))),{f:f?f+"!"+a:a,n:a,pr:f,p:d}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(c,d,e,f){var h,k,l,m,n,s,u=[],v=typeof e;if(f=f||c,"undefined"===v||"function"===v){for(d=!d.length&&e.length?["require","exports","module"]:d,n=0;n<d.length;n+=1)if(m=o(d[n],f),k=m.f,"require"===k)u[n]=p.require(c);else if("exports"===k)u[n]=p.exports(c),s=!0;else if("module"===k)h=u[n]=p.module(c);else if(b(q,k)||b(r,k)||b(t,k))u[n]=j(k);else{if(!m.p)throw new Error(c+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=e?e.apply(q[c],u):void 0,c&&(h&&h.exports!==a&&h.exports!==q[c]?q[c]=h.exports:l===a&&s||(q[c]=l))}else c&&(q[c]=e)},d=e=n=function(b,c,d,e,f){if("string"==typeof b)return p[b]?p[b](c):j(o(b,c).f);if(!b.splice){if(s=b,s.deps&&n(s.deps,s.callback),!c)return;c.splice?(b=c,c=d,d=null):b=a}return c=c||function(){},"function"==typeof d&&(d=e,e=f),e?m(a,b,c,d):setTimeout(function(){m(a,b,c,d)},4),n},n.config=function(a){return n(a)},d._defined=q,f=function(a,c,d){if("string"!=typeof a)throw new Error("See almond README: incorrect module build, no module name");c.splice||(d=c,c=[]),b(q,a)||b(r,a)||(r[a]=[a,c,d])},f.amd={jQuery:!0}}(),f("../node_modules/almond/almond",function(){}),function(){var a,b,c,d,e,g,h,i,j,k,l,m,n,o,p;c=Math.floor,k=Math.min,b=function(a,b){return b>a?-1:a>b?1:0},j=function(a,d,e,f,g){var h;if(null==e&&(e=0),null==g&&(g=b),0>e)throw new Error("lo must be non-negative");for(null==f&&(f=a.length);f>e;)h=c((e+f)/2),g(d,a[h])<0?f=h:e=h+1;return[].splice.apply(a,[e,e-e].concat(d)),d},g=function(a,c,d){return null==d&&(d=b),a.push(c),o(a,0,a.length-1,d)},e=function(a,c){var d,e;return null==c&&(c=b),d=a.pop(),a.length?(e=a[0],a[0]=d,p(a,0,c)):e=d,e},i=function(a,c,d){var e;return null==d&&(d=b),e=a[0],a[0]=c,p(a,0,d),e},h=function(a,c,d){var e;return null==d&&(d=b),a.length&&d(a[0],c)<0&&(e=[a[0],c],c=e[0],a[0]=e[1],p(a,0,d)),c},d=function(a,d){var e,f,g,h,i,j;for(null==d&&(d=b),h=function(){j=[];for(var b=0,d=c(a.length/2);d>=0?d>b:b>d;d>=0?b++:b--)j.push(b);return j}.apply(this).reverse(),i=[],f=0,g=h.length;g>f;f++)e=h[f],i.push(p(a,e,d));return i},n=function(a,c,d){var e;return null==d&&(d=b),e=a.indexOf(c),-1!==e?(o(a,0,e,d),p(a,e,d)):void 0},l=function(a,c,e){var f,g,i,j,k;if(null==e&&(e=b),g=a.slice(0,c),!g.length)return g;for(d(g,e),k=a.slice(c),i=0,j=k.length;j>i;i++)f=k[i],h(g,f,e);return g.sort(e).reverse()},m=function(a,c,f){var g,h,i,l,m,n,o,p,q,r;if(null==f&&(f=b),10*c<=a.length){if(l=a.slice(0,c).sort(f),!l.length)return l;for(i=l[l.length-1],p=a.slice(c),m=0,o=p.length;o>m;m++)g=p[m],f(g,i)<0&&(j(l,g,0,null,f),l.pop(),i=l[l.length-1]);return l}for(d(a,f),r=[],h=n=0,q=k(c,a.length);q>=0?q>n:n>q;h=q>=0?++n:--n)r.push(e(a,f));return r},o=function(a,c,d,e){var f,g,h;for(null==e&&(e=b),f=a[d];d>c&&(h=d-1>>1,g=a[h],e(f,g)<0);)a[d]=g,d=h;return a[d]=f},p=function(a,c,d){var e,f,g,h,i;for(null==d&&(d=b),f=a.length,i=c,g=a[c],e=2*c+1;f>e;)h=e+1,f>h&&!(d(a[e],a[h])<0)&&(e=h),a[c]=a[e],c=e,e=2*c+1;return a[c]=g,o(a,i,c,d)},a=function(){function a(a){this.cmp=null!=a?a:b,this.nodes=[]}return a.push=g,a.pop=e,a.replace=i,a.pushpop=h,a.heapify=d,a.updateItem=n,a.nlargest=l,a.nsmallest=m,a.prototype.push=function(a){return g(this.nodes,a,this.cmp)},a.prototype.pop=function(){return e(this.nodes,this.cmp)},a.prototype.peek=function(){return this.nodes[0]},a.prototype.contains=function(a){return-1!==this.nodes.indexOf(a)},a.prototype.replace=function(a){return i(this.nodes,a,this.cmp)},a.prototype.pushpop=function(a){return h(this.nodes,a,this.cmp)},a.prototype.heapify=function(){return d(this.nodes,this.cmp)},a.prototype.updateItem=function(a){return n(this.nodes,a,this.cmp)},a.prototype.clear=function(){return this.nodes=[]},a.prototype.empty=function(){return 0===this.nodes.length},a.prototype.size=function(){return this.nodes.length},a.prototype.clone=function(){var b;return b=new a,b.nodes=this.nodes.slice(0),b},a.prototype.toArray=function(){return this.nodes.slice(0)},a.prototype.insert=a.prototype.push,a.prototype.top=a.prototype.peek,a.prototype.front=a.prototype.peek,a.prototype.has=a.prototype.contains,a.prototype.copy=a.prototype.clone,a}(),function(a,b){return"function"==typeof f&&f.amd?f("heap",[],b):"object"==typeof exports?module.exports=b():a.Heap=b()}(this,function(){return a})}.call(this),f("util/constants",["require","exports","module"],function(a,b,c){return{ADD_CELL:1,MOD_CELL:2,DATA:"data",FIELDS:"fields",SCALES:"scales",SIGNAL:"signal",SIGNALS:"signals",GROUP:"group",ENTER:"enter",UPDATE:"update",EXIT:"exit",SENTINEL:{sentinel:1},ADD:"add",REMOVE:"remove",TOGGLE:"toggle",CLEAR:"clear",LINEAR:"linear",ORDINAL:"ordinal",LOG:"log",POWER:"pow",TIME:"time",QUANTILE:"quantile",DOMAIN:"domain",RANGE:"range",MARK:"mark",AXIS:"axis",COUNT:"count",MIN:"min",MAX:"max",ASC:"asc",DESC:"desc"}}),f("dataflow/changeset",["require","exports","module","../util/constants"],function(a,b,c){function d(a,b){var c={};return g(a,c),c.add=[],c.mod=[],c.rem=[],c.reflow=b,c}function e(a){a._prev=void 0===a._prev?void 0:h.SENTINEL}function f(a){for(i=0,len=a.add.length;i<len;++i)e(a.add[i]);for(i=0,len=a.mod.length;i<len;++i)e(a.mod[i])}function g(a,b){b.stamp=a?a.stamp:0,b.sort=a?a.sort:null,b.facet=a?a.facet:null,b.trans=a?a.trans:null,j.forEach(function(c){b[c]=a?a[c]:{}})}var h=a("../util/constants"),j=[h.DATA,h.FIELDS,h.SCALES,h.SIGNALS];return{create:d,copy:g,finalize:f}}),f("util/config",["require","exports","module","d3"],function(a,b,c){var d=a("d3"),e={};return e.debug=!1,e.isNode="undefined"!=typeof c&&this.exports!==c,e.domainWhiteList=!1,e.safeMode=!1,e.baseURL="",e.svgNamespace='version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"',e.autopadInset=5,e.scale={time:d.time.scale,utc:d.time.scale.utc},e.render={lineWidth:1,lineCap:"butt",font:"sans-serif",fontSize:11},e.axis={orient:"bottom",ticks:10,padding:3,axisColor:"#000",gridColor:"#d8d8d8",tickColor:"#000",tickLabelColor:"#000",axisWidth:1,tickWidth:1,tickSize:6,tickLabelFontSize:11,tickLabelFont:"sans-serif",titleColor:"#000",titleFont:"sans-serif",titleFontSize:11,titleFontWeight:"bold",titleOffset:35},e.legend={orient:"right",offset:10,padding:3,gradientStrokeColor:"#888",gradientStrokeWidth:1,gradientHeight:16,gradientWidth:100,labelColor:"#000",labelFontSize:10,labelFont:"sans-serif",labelAlign:"left",labelBaseline:"middle",labelOffset:8,symbolShape:"circle",symbolSize:50,symbolColor:"#888",symbolStrokeWidth:1,titleColor:"#000",titleFont:"sans-serif",titleFontSize:11,titleFontWeight:"bold"},e.color={rgb:[128,128,128],lab:[50,0,0],hcl:[0,0,50],hsl:[0,0,.5]},e.range={category10:["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],category20:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"],shapes:["circle","cross","diamond","square","triangle-down","triangle-up"]},e}),f("util/index",["require","exports","module","./config","heap"],function(a,b,c){function d(a){return a.replace(j,"$1\\'")}function e(a,b,c){var d=0,e=a.split(k);return a=c?(e=e.reverse()).filter(function(a){return d+=a.length,b>=d}).reverse():e.filter(function(a){return d+=a.length,b>=d}),a.length?a.join("").trim():e[0].slice(0,b)}function f(a){console.log(a)}var g=a("./config"),h={},i=Object.prototype.toString;h.isObject=function(a){return a===Object(a)},h.isFunction=function(a){return"[object Function]"==i.call(a)},h.isString=function(a){return"[object String]"==i.call(a)},h.isArray=Array.isArray||function(a){return"[object Array]"==i.call(a)},h.isNumber=function(a){return"[object Number]"==i.call(a)},h.isBoolean=function(a){return"[object Boolean]"==i.call(a)},h.isTree=function(a){return a&&a.__vgtree__},h.tree=function(a,b){var c=[a];return c.__vgtree__=!0,c.children=b||"children",c},h.number=function(a){return+a},h["boolean"]=function(a){return!!a},h.identity=function(a){return a},h["true"]=function(){return!0},h.extend=function(a){for(var b,c,d=1,e=arguments.length;e>d;++d){b=arguments[d];for(c in b)a[c]=b[c]}return a},h.duplicate=function(a){return JSON.parse(JSON.stringify(a))},h.equal=function(a,b){return JSON.stringify(a)==JSON.stringify(b)},h.field=function(a){return a.split("\\.").map(function(a){return a.split(".")}).reduce(function(a,b){return a.length&&(a[a.length-1]+="."+b.shift()),a.push.apply(a,b),a},[])},h.accessor=function(a){var b;return h.isFunction(a)||null==a?a:h.isString(a)&&(b=h.field(a)).length>1?function(a){return b.reduce(function(a,b){return a[b]},a)}:function(b){return b[a]}},h.comparator=function(a){var b=[];return void 0===a&&(a=[]),a=h.array(a).map(function(a){var c=1;return"-"===a[0]?(c=-1,a=a.slice(1)):"+"===a[0]&&(c=1,a=a.slice(1)),b.push(c),h.accessor(a)}),function(c,d){var e,f,g,h,i;for(e=0,f=a.length;f>e;++e){if(g=a[e],h=g(c),i=g(d),i>h)return-1*b[e];if(h>i)return b[e]}return 0}},h.cmp=function(a,b){return b>a?-1:a>b?1:0},h.numcmp=function(a,b){return a-b},h.array=function(a){return null!=a?h.isArray(a)?a:[a]:[]},h.values=function(a){return h.isObject(a)&&!h.isArray(a)&&a.values?h.isFunction(a.values)?a.values():a.values:a},h.tuple_ids=function(a){return a.reduce(function(a,b){return a[b._id]=1,a},{})},h.str=function(a){return h.isArray(a)?"["+a.map(h.str)+"]":h.isObject(a)?JSON.stringify(a):h.isString(a)?"'"+d(a)+"'":a};var j=/(^|[^\\])'/g;h.keys=function(a){var b=[];for(var c in a)b.push(c);return b},h.unique=function(a,b,c){if(!h.isArray(a)||0==a.length)return[];b=b||h.identity,c=c||[];for(var d,e=0,f=a.length;f>e;++e)d=b(a[e]),c.indexOf(d)<0&&c.push(d);return c},h.minIndex=function(a,b){if(!h.isArray(a)||0==a.length)return-1;b=b||h.identity;for(var c=0,d=b(a[0]),e=d,f=1,g=a.length;g>f;++f)e=b(a[f]),d>e&&(d=e,c=f);return c},h.maxIndex=function(a,b){if(!h.isArray(a)||0==a.length)return-1;b=b||h.identity;for(var c=0,d=b(a[0]),e=d,f=1,g=a.length;g>f;++f)e=b(a[f]),e>d&&(d=e,c=f);return c},h.truncate=function(a,b,c,d,f){var g=a.length;if(b>=g)return a;f=f||"...";var h=Math.max(0,b-f.length);switch(c){case"left":return f+(d?e(a,h,1):a.slice(g-h));case"middle":case"center":var i=Math.ceil(h/2),j=Math.floor(h/2);return(d?e(a,i):a.slice(0,i))+f+(d?e(a,j,1):a.slice(g-j));default:return(d?e(a,h):a.slice(0,h))+f}};var k=/([\u0009\u000A\u000B\u000C\u000D\u0020\u00A0\u1680\u180E\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u2028\u2029\u3000\uFEFF])/;h.fontString=function(a){return(a.fontStyle?a.fontStyle+" ":"")+(a.fontVariant?a.fontVariant+" ":"")+(a.fontWeight?a.fontWeight+" ":"")+(null!=a.fontSize?a.fontSize:g.render.fontSize)+"px "+(a.font||g.render.font)},h.log=function(a){f("[Vega Log] "+a)},h.error=function(a){a="[Vega Err] "+a,f(a),"undefined"!=typeof alert&&alert(a)};var l;return h.debug=function(a,b){if(g.debug){var c=Function.prototype.bind.call(console.log,console);b.unshift(a.stamp||-1),b.unshift(Date.now()-l),a.add&&b.push(a.add.length,a.mod.length,a.rem.length,!!a.reflow),c.apply(console,b),l=Date.now()}},h.Heap=a("heap"),h}),f("dataflow/tuple",["require","exports","module","../util/index","../util/constants"],function(a,b,c){function d(a,b){return a=i.isObject(a)?a:{data:a},a._id=k++,a._prev=void 0!==b?b||j.SENTINEL:void 0,a}function e(a,b){return d(Object.create(a),b)}function f(a,b,c){var d=a[b];d!==c&&(g(a,b),a[b]=c)}function g(a,b){void 0!==a._prev&&(a._prev=a._prev===j.SENTINEL?{}:a._prev,a._prev[b]=a[b])}function h(){k=1}var i=a("../util/index"),j=a("../util/constants"),k=1;return{ingest:d,derive:e,set:f,prev:g,reset:h}}),f("dataflow/Node",["require","exports","module","../util/index","../util/constants"],function(a,b,c){function d(a){return a&&this.init(a),this}var e=a("../util/index"),f=a("../util/constants"),g=[f.DATA,f.FIELDS,f.SCALES,f.SIGNALS],h=1,i=d.prototype;return i.init=function(a){return this._id=h++,this._graph=a,this._rank=++a._rank,this._stamp=0,this._listeners=[],this._registered={},this._deps={data:[],fields:[],scales:[],signals:[]},this._isRouter=!1,this._isCollector=!1,this._revises=!1,this},i.clone=function(){var a=new d(this._graph);return a.evaluate=this.evaluate,a._deps=this._deps,a._isRouter=this._isRouter,a._isCollector=this._isCollector,a},i.rank=function(){return this._rank},i.last=function(a){return arguments.length?(this._stamp=a,this):this._stamp},i.dependency=function(a,b){var c=this._deps[a];if(1===arguments.length)return c;if(null===b)for(;c.length>0;)c.pop();else!e.isArray(b)&&c.indexOf(b)<0?c.push(b):c.push.apply(c,e.array(b));return this},i.router=function(a){return arguments.length?(this._isRouter=!!a,this):this._isRouter},i.collector=function(a){return arguments.length?(this._isCollector=!!a,this):this._isCollector},i.revises=function(a){return arguments.length?(this._revises=!!a,this):this._revises},i.listeners=function(){return this._listeners},i.addListener=function(a){if(!(a instanceof d))throw"Listener is not a Node";if(this._registered[a._id])return this;if(this._listeners.push(a),this._registered[a._id]=1,this._rank>a._rank)for(var b=[a];b.length;){var c=b.splice(0,1)[0];c._rank=++this._graph._rank,b.push.apply(b,c._listeners)}return this},i.removeListener=function(a){for(var b=!1,c=0,d=this._listeners.length;d>c&&!b;c++)this._listeners[c]===a&&(this._listeners.splice(c,1),this._registered[a._id]=null,b=!0);return b},i.disconnect=function(){this._listeners=[],this._registered={}},i.evaluate=function(a){return a},i.reevaluate=function(a){var b=this,c=!1;return g.some(function(d){return c=c||b._deps[d].some(function(b){return!!a[d][b]})})},d}),f("dataflow/Collector",["require","exports","module","./Node","./changeset","../util/index","../util/constants"],function(a,b,c){function d(a){return e.prototype.init.call(this,a),this._data=[],this.router(!0).collector(!0)}var e=a("./Node"),f=a("./changeset"),g=a("../util/index"),h=(a("../util/constants"),d.prototype=new e);return h.data=function(){return this._data},h.evaluate=function(a){if(g.debug(a,["collecting"]),a.reflow)return a=f.create(a),a.mod=this._data.slice(),a;if(a.rem.length){var b=a.rem.reduce(function(a,b){return a[b._id]=1,a},{});this._data=this._data.filter(function(a){return 1!==b[a._id]})}return a.add.length&&(this._data=this._data.length?this._data.concat(a.add):a.add),a.sort&&this._data.sort(a.sort),a},d}),f("dataflow/Datasource",["require","exports","module","./changeset","./tuple","./Node","./Collector","../util/index","../util/constants"],function(a,b,c){function d(a,b,c){this._graph=a,this._name=b,this._data=[],this._source=null,this._facet=c,this._input=f.create(),this._output=null,this._pipeline=null,this._collector=null,this._revises=!1}function e(a){void 0===a._prev&&(a._prev=k.SENTINEL)}var f=a("./changeset"),g=a("./tuple"),h=a("./Node"),i=a("./Collector"),j=a("../util/index"),k=a("../util/constants"),l=d.prototype;return l.name=function(a){return arguments.length?(this._name=a,this):this._name},l.source=function(a){return arguments.length?this._source=this._graph.data(a):this._source},l.add=function(a){var b=this._revises?null:void 0;return this._input.add=this._input.add.concat(j.array(a).map(function(a){return g.ingest(a,b)})),this},l.remove=function(a){var b=this._data.filter(a);return this._input.rem=this._input.rem.concat(b),this},l.update=function(a,b,c){{var d=this._input.mod,e=j.tuple_ids(d);this._revises?null:void 0}return this._input.fields[b]=1,this._data.filter(a).forEach(function(a){var f=a[b],h=c(a);f!==h&&(g.set(a,b,h),1!==e[a._id]&&(d.push(a),e[a._id]=1))}),this},l.values=function(a){return arguments.length?(this._input.rem=this._data.slice(),a&&this.add(a),this):this._collector?this._collector.data():this._data},l.revises=function(a){return arguments.length?(!this._revises&&a&&(this._data.forEach(e),this._input.add.forEach(e)),this._revises=this._revises||a,this):this._revises},l.last=function(){return this._output},l.fire=function(a){a&&(this._input=a),this._graph.propagate(this._input,this._pipeline[0])},l.pipeline=function(a){var b=this;if(!arguments.length)return this._pipeline;a.length&&(b._collector=new i(this._graph),a.push(b._collector),b._revises=a.some(function(a){return a.revises()}));var c=new h(this._graph).router(!0).collector(!0);c.evaluate=function(a){j.debug(a,["input",b._name]);var c,d=b._input,e=f.create(a);return j.keys(d.fields).forEach(function(a){e.fields[a]=1}),a.reflow?e.mod=b._data.slice():(d.rem.length&&(c=j.tuple_ids(d.rem),b._data=b._data.filter(function(a){return 1!==c[a._id]})),d.add.length&&(b._data=b._data.concat(d.add)),b._input=f.create(),e.add=d.add,e.mod=d.mod,e.rem=d.rem),e.facet=b._facet,e},a.unshift(c);var d=new h(this._graph).router(!0).collector(!0);return d.evaluate=function(a){j.debug(a,["output",b._name]);var c=f.create(a,!0);return b._facet&&(b._facet.values=b.values(),a.facet=null),b._output=a,c.data[b._name]=1,c},a.push(d),this._pipeline=a,this._graph.connect(b._pipeline),this},l.listener=function(){var a=new h(this._graph).router(!0),b=this,c=this._revises?null:void 0;return a.evaluate=function(a){b._srcMap=b._srcMap||{};var d=b._srcMap,e=f.create(a);return e.add=a.add.map(function(a){return d[a._id]=g.derive(a,void 0!==a._prev?a._prev:c)}),e.mod=a.mod.map(function(a){return d[a._id]}),e.rem=a.rem.map(function(a){var b=d[a._id];return d[a._id]=null,b}),b._input=e},a.addListener(this._pipeline[0]),a},l.addListener=function(a){return a instanceof d?this._collector?this._collector.addListener(a.listener()):this._pipeline[0].addListener(a.listener()):this._pipeline[this._pipeline.length-1].addListener(a),this},l.removeListener=function(a){this._pipeline[this._pipeline.length-1].removeListener(a)},d}),f("dataflow/Signal",["require","exports","module","./Node","./changeset","../util/index"],function(a,b,c){function d(a,b,c){return e.prototype.init.call(this,a),this._name=b,this._value=c,this}var e=a("./Node"),f=a("./changeset"),g=(a("../util/index"),d.prototype=new e);return g.name=function(){return this._name},g.value=function(a){return arguments.length?(this._value=a,this):this._value},g.fire=function(a){a||(a=f.create(null,!0)),a.signals[this._name]=1,this._graph.propagate(a,this)},d}),f("dataflow/Graph",["require","exports","module","heap","./Datasource","./Signal","./changeset","../util/index","../util/constants"],function(a,b,c){function d(){this._stamp=0,this._rank=0,this._data={},this._signals={},this.doNotPropagate={}}function e(a){var b=this;return j.isArray(a)?a.map(function(a){b._signals[a]}):this._signals[a]}function f(a,b){var c,d,e,f;for(e=0,f=a.length;f>e;++e)c=a[e],c.collector()&&(d=c),b(c,d,e)}var g=a("heap"),h=a("./Datasource"),i=a("./Signal"),j=(a("./changeset"),a("../util/index")),k=a("../util/constants"),l=d.prototype;l.data=function(a,b,c){return 1===arguments.length?this._data[a]:this._data[a]=new h(this,a,c).pipeline(b)},l.signal=function(a,b){return 1===arguments.length?e.call(this,a):this._signals[a]=new i(this,a,b)},l.signalValues=function(a){var b=this;return j.isArray(a)?a.reduce(function(a,c){return a[c]=b._signals[c].value(),a},{}):this._signals[a].value()},l.signalRef=function(a){j.isArray(a)||(a=j.field(a));var b=this.signal(a.shift()).value();if(a.length>0){var c=Function("s","return s["+a.map(j.str).join("][")+"]");b=c.call(null,b)}return b};var m=function(a,b){return a.rank==b.rank?a.pulse.reflow?1:-1:a.rank-b.rank};return l.propagate=function(a,b){var c,d,e,f,h,i,k,l,n=new g(m);if(a.stamp)throw"Pulse already has a non-zero stamp";for(a.stamp=++this._stamp,n.push({node:b,pulse:a,rank:b.rank()});n.size()>0;)if(c=n.pop(),e=c.node,f=c.pulse,h=c.rank,d=e._listeners,l=f.reflow&&e.last()>=f.stamp,!l)if(h==e.rank()){if(f=this.evaluate(f,e),f!==this.doNotPropagate)for(i=0,k=d.length;k>i;i++)n.push({node:d[i],pulse:f,rank:d[i]._rank})}else j.debug(f,["Rank mismatch",h,e.rank()]),n.push({node:e,pulse:f,rank:e.rank()})},l.connect=function(a){j.debug({},["connecting"]);var b=this;return f(a,function(c,d,e){var f=c.dependency(k.DATA),g=c.dependency(k.SIGNALS);f.length>0&&f.forEach(function(a){b.data(a).revises(c.revises()).addListener(d)}),g.length>0&&g.forEach(function(a){b.signal(a).addListener(d)}),e>0&&a[e-1].addListener(a[e])}),a},l.disconnect=function(a){j.debug({},["disconnecting"]);var b=this;return f(a,function(a,c,d){var e=a.dependency(k.DATA),f=a.dependency(k.SIGNALS);e.length>0&&e.forEach(function(a){b.data(a).removeListener(c)}),f.length>0&&f.forEach(function(a){b.signal(a).removeListener(c)}),a.disconnect()}),a},l.reevaluate=function(a,b){var c=!a.reflow||a.reflow&&b.last()>=a.stamp,d=!!a.add.length||!!a.rem.length||b.router();return d=d||!c,d||b.reevaluate(a)},l.evaluate=function(a,b){return this.reevaluate(a,b)?(a=b.evaluate(a),b.last(a.stamp),a):a},d}),f("scene/Encoder",["require","exports","module","../dataflow/Node","../util/index","../util/constants"],function(a,b,c){function d(a,b){var c=b.def.properties||{},d=c.update;return f.prototype.init.call(this,a.graph),this._model=a,this._mark=b,d&&(this.dependency(h.DATA,d.data),this.dependency(h.SCALES,d.scales),this.dependency(h.SIGNALS,d.signals)),this}function e(a,b,c,d){var e=this._model,f=a.encode,g=this._graph.signalValues(a.signals||[]),h=(a.data||[]).reduce(function(a,b){return a[b]=e.data(b).values(),a},{});f.call(f,b,b.mark.group||b,c,h,g,e.predicates())}var f=a("../dataflow/Node"),g=a("../util/index"),h=a("../util/constants"),i={},j=d.prototype=new f;return j.evaluate=function(a){g.debug(a,["encoding",this._mark.def.type]);var b,c,d,f=(this._mark.items,this._mark.def.properties||{}),j=f.enter,k=f.update,l=f.exit;for(b=0,c=a.rem.length;c>b;++b)d=a.rem[b],k&&e.call(this,k,d,a.trans),l&&e.call(this,l,d,a.trans),a.trans&&!l?a.trans.interpolate(d,i):a.trans||d.remove();for(b=0,c=a.add.length;c>b;++b)d=a.add[b],j&&e.call(this,j,d,a.trans),k&&e.call(this,k,d,a.trans),d.status=h.UPDATE;if(k)for(b=0,c=a.mod.length;c>b;++b)d=a.mod[b],e.call(this,k,d,a.trans);return a},d}),f("core/Bounds",["require","exports","module"],function(a,b,c){var d=function(a){this.clear(),a&&this.union(a)},e=d.prototype;return e.clear=function(){return this.x1=+Number.MAX_VALUE,this.y1=+Number.MAX_VALUE,this.x2=-Number.MAX_VALUE,this.y2=-Number.MAX_VALUE,this},e.set=function(a,b,c,d){return this.x1=a,this.y1=b,this.x2=c,this.y2=d,this},e.add=function(a,b){return a<this.x1&&(this.x1=a),b<this.y1&&(this.y1=b),a>this.x2&&(this.x2=a),b>this.y2&&(this.y2=b),this},e.expand=function(a){return this.x1-=a,this.y1-=a,this.x2+=a,this.y2+=a,this},e.round=function(){return this.x1=Math.floor(this.x1),this.y1=Math.floor(this.y1),this.x2=Math.ceil(this.x2),this.y2=Math.ceil(this.y2),this},e.translate=function(a,b){return this.x1+=a,this.x2+=a,this.y1+=b,this.y2+=b,this},e.rotate=function(a,b,c){var d=Math.cos(a),e=Math.sin(a),f=b-b*d+c*e,g=c-b*e-c*d,h=this.x1,i=this.x2,j=this.y1,k=this.y2;return this.clear().add(d*h-e*j+f,e*h+d*j+g).add(d*h-e*k+f,e*h+d*k+g).add(d*i-e*j+f,e*i+d*j+g).add(d*i-e*k+f,e*i+d*k+g)},e.union=function(a){return a.x1<this.x1&&(this.x1=a.x1),a.y1<this.y1&&(this.y1=a.y1),a.x2>this.x2&&(this.x2=a.x2),a.y2>this.y2&&(this.y2=a.y2),this},e.encloses=function(a){return a&&this.x1<=a.x1&&this.x2>=a.x2&&this.y1<=a.y1&&this.y2>=a.y2},e.intersects=function(a){return a&&!(this.x2<a.x1||this.x1>a.x2||this.y2<a.y1||this.y1>a.y2)},e.contains=function(a,b){return!(a<this.x1||a>this.x2||b<this.y1||b>this.y2)},e.width=function(){return this.x2-this.x1},e.height=function(){return this.y2-this.y1},d}),f("render/canvas/path",["require","exports","module","d3","../../core/Bounds"],function(a,b,c){function d(a){var b,c,d,e=[];a=a.slice().replace(q[0],"###$1").split(q[1]).slice(1);for(var f,g,h=0,i=a.length;i>h;h++){b=a[h],c=b.slice(1).trim().replace(q[2],"$1###-").split(q[3]),g=[b.charAt(0)];for(var f=0,j=c.length;j>f;f++)d=parseFloat(c[f]),isNaN(d)||g.push(d);var k=g[0].toLowerCase(),l=p[k];if(g.length-1>l)for(var m=1,n=g.length;n>m;m+=l)e.push([g[0]].concat(g.slice(m,m+l)));else e.push(g)}return e}function e(a,b,c,d,e,f,i){for(var j=d[0],k=d[1],l=d[2],m=d[3],n=d[4],o=d[5],p=d[6],q=g(o,p,j,k,m,n,l,b,c),r=0;r<q.length;r++){var s=h.apply(null,q[r]);a.bezierCurveTo.apply(a,s),e.add(s[0]-f,s[1]-i),e.add(s[2]-f,s[3]-i),e.add(s[4]-f,s[5]-i)}}function f(a,b,c,d){for(var e=c[0],f=c[1],i=c[2],j=c[3],k=c[4],l=c[5],m=c[6],n=g(l,m,e,f,j,k,i,a,b),o=0;o<n.length;o++){var p=h.apply(null,n[o]);d.add(p[0],p[1]),d.add(p[2],p[3]),d.add(p[4],p[5])}}function g(a,b,c,d,e,f,g,h,i){if(m=t.call(arguments),r[m])return r[m];var j=g*(Math.PI/180),k=Math.sin(j),l=Math.cos(j);c=Math.abs(c),d=Math.abs(d);var n=l*(h-a)*.5+k*(i-b)*.5,o=l*(i-b)*.5-k*(h-a)*.5,p=n*n/(c*c)+o*o/(d*d);p>1&&(p=Math.sqrt(p),c*=p,d*=p);var q=l/c,s=k/c,u=-k/d,v=l/d,w=q*h+s*i,x=u*h+v*i,y=q*a+s*b,z=u*a+v*b,A=(y-w)*(y-w)+(z-x)*(z-x),B=1/A-.25;0>B&&(B=0);var C=Math.sqrt(B);f==e&&(C=-C);var D=.5*(w+y)-C*(z-x),E=.5*(x+z)+C*(y-w),F=Math.atan2(x-E,w-D),G=Math.atan2(z-E,y-D),H=G-F;0>H&&1==f?H+=2*Math.PI:H>0&&0==f&&(H-=2*Math.PI);for(var I=Math.ceil(Math.abs(H/(.5*Math.PI+.001))),J=[],K=0;I>K;K++){var L=F+K*H/I,M=F+(K+1)*H/I;J[K]=[D,E,L,M,c,d,k,l]}return r[m]=J}function h(a,b,c,d,e,f,g,h){if(m=t.call(arguments),s[m])return s[m];var i=h*e,j=-g*f,k=g*e,l=h*f,n=Math.cos(c),o=Math.sin(c),p=Math.cos(d),q=Math.sin(d),r=.5*(d-c),u=Math.sin(.5*r),v=8/3*u*u/Math.sin(r),w=a+n-v*o,x=b+o+v*n,y=a+p,z=b+q,A=y+v*q,B=z-v*p;return s[m]=[i*w+j*x,k*w+l*x,i*A+j*B,k*A+l*B,i*y+j*z,k*y+l*z]}function i(a,b,c,d){var f,g,h,i,j,k=null,l=0,m=0,n=0,p=0,q=new o;void 0==c&&(c=0),void 0==d&&(d=0),a.beginPath();for(var r=0,s=b.length;s>r;++r){switch(f=b[r],f[0]){case"l":l+=f[1],m+=f[2],a.lineTo(l+c,m+d),q.add(l,m);break;case"L":l=f[1],m=f[2],a.lineTo(l+c,m+d),q.add(l,m);break;case"h":l+=f[1],a.lineTo(l+c,m+d),q.add(l,m);break;case"H":l=f[1],a.lineTo(l+c,m+d),q.add(l,m);break;case"v":m+=f[1],a.lineTo(l+c,m+d),q.add(l,m);break;case"V":m=f[1],a.lineTo(l+c,m+d),q.add(l,m);break;case"m":l+=f[1],m+=f[2],a.moveTo(l+c,m+d),q.add(l,m);break;case"M":l=f[1],m=f[2],a.moveTo(l+c,m+d),q.add(l,m);break;case"c":g=l+f[5],h=m+f[6],n=l+f[3],p=m+f[4],a.bezierCurveTo(l+f[1]+c,m+f[2]+d,n+c,p+d,g+c,h+d),q.add(l+f[1],m+f[2]),q.add(n,p),q.add(g,h),l=g,m=h;break;case"C":l=f[5],m=f[6],n=f[3],p=f[4],a.bezierCurveTo(f[1]+c,f[2]+d,n+c,p+d,l+c,m+d),q.add(f[1],f[2]),q.add(n,p),q.add(l,m);break;case"s":g=l+f[3],h=m+f[4],n=2*l-n,p=2*m-p,a.bezierCurveTo(n+c,p+d,l+f[1]+c,m+f[2]+d,g+c,h+d),q.add(n,p),q.add(l+f[1],m+f[2]),q.add(g,h),n=l+f[1],p=m+f[2],l=g,m=h;break;case"S":g=f[3],h=f[4],n=2*l-n,p=2*m-p,a.bezierCurveTo(n+c,p+d,f[1]+c,f[2]+d,g+c,h+d),l=g,m=h,q.add(f[1],f[2]),q.add(n,p),q.add(g,h),n=f[1],p=f[2];break;case"q":g=l+f[3],h=m+f[4],n=l+f[1],p=m+f[2],a.quadraticCurveTo(n+c,p+d,g+c,h+d),l=g,m=h,q.add(n,p),q.add(g,h);break;case"Q":g=f[3],h=f[4],a.quadraticCurveTo(f[1]+c,f[2]+d,g+c,h+d),l=g,m=h,n=f[1],p=f[2],q.add(n,p),q.add(g,h);break;case"t":g=l+f[1],h=m+f[2],null===k[0].match(/[QqTt]/)?(n=l,p=m):"t"===k[0]?(n=2*l-i,p=2*m-j):"q"===k[0]&&(n=2*l-n,p=2*m-p),i=n,j=p,a.quadraticCurveTo(n+c,p+d,g+c,h+d),l=g,m=h,n=l+f[1],p=m+f[2],q.add(n,p),q.add(g,h);break;case"T":g=f[1],h=f[2],n=2*l-n,p=2*m-p,a.quadraticCurveTo(n+c,p+d,g+c,h+d),l=g,m=h,q.add(n,p),q.add(g,h);break;case"a":e(a,l+c,m+d,[f[1],f[2],f[3],f[4],f[5],f[6]+l+c,f[7]+m+d],q,c,d),l+=f[6],m+=f[7];break;case"A":e(a,l+c,m+d,[f[1],f[2],f[3],f[4],f[5],f[6]+c,f[7]+d],q,c,d),l=f[6],m=f[7];break;case"z":case"Z":a.closePath()}k=f}return q.translate(c,d)}function j(a,b){for(var c,d,e,g,h,i=null,j=0,k=0,l=0,m=0,n=0,o=a.length;o>n;++n){switch(c=a[n],c[0]){case"l":j+=c[1],k+=c[2],b.add(j,k);break;case"L":j=c[1],k=c[2],b.add(j,k);break;case"h":j+=c[1],b.add(j,k);break;case"H":j=c[1],b.add(j,k);break;case"v":k+=c[1],b.add(j,k);break;case"V":k=c[1],b.add(j,k);break;case"m":j+=c[1],k+=c[2],b.add(j,k);break;case"M":j=c[1],k=c[2],b.add(j,k);break;case"c":d=j+c[5],e=k+c[6],l=j+c[3],m=k+c[4],b.add(j+c[1],k+c[2]),b.add(l,m),b.add(d,e),j=d,k=e;break;case"C":j=c[5],k=c[6],l=c[3],m=c[4],b.add(c[1],c[2]),b.add(l,m),b.add(j,k);break;case"s":d=j+c[3],e=k+c[4],l=2*j-l,m=2*k-m,b.add(l,m),b.add(j+c[1],k+c[2]),b.add(d,e),l=j+c[1],m=k+c[2],j=d,k=e;break;case"S":d=c[3],e=c[4],l=2*j-l,m=2*k-m,j=d,k=e,b.add(c[1],c[2]),b.add(l,m),b.add(d,e),l=c[1],m=c[2];break;case"q":d=j+c[3],e=k+c[4],l=j+c[1],m=k+c[2],j=d,k=e,b.add(l,m),b.add(d,e);break;case"Q":d=c[3],e=c[4],j=d,k=e,l=c[1],m=c[2],b.add(l,m),b.add(d,e);break;case"t":d=j+c[1],e=k+c[2],null===i[0].match(/[QqTt]/)?(l=j,m=k):"t"===i[0]?(l=2*j-g,m=2*k-h):"q"===i[0]&&(l=2*j-l,m=2*k-m),g=l,h=m,j=d,k=e,l=j+c[1],m=k+c[2],b.add(l,m),b.add(d,e);break;case"T":d=c[1],e=c[2],l=2*j-l,m=2*k-m,j=d,k=e,b.add(l,m),b.add(d,e);break;case"a":f(j,k,[c[1],c[2],c[3],c[4],c[5],c[6]+j,c[7]+k],b),j+=c[6],k+=c[7];break;case"A":f(j,k,[c[1],c[2],c[3],c[4],c[5],c[6],c[7]],b),j=c[6],k=c[7];break;case"z":case"Z":}i=c}return b}function k(a){var b=a[0],c=n.svg.area().x(function(a){return a.x}).y1(function(a){return a.y}).y0(function(a){return a.y+a.height});return b.interpolate&&c.interpolate(b.interpolate),null!=b.tension&&c.tension(b.tension),c(a)}function l(a){var b=a[0],c=n.svg.line().x(function(a){return a.x}).y(function(a){return a.y});return b.interpolate&&c.interpolate(b.interpolate),null!=b.tension&&c.tension(b.tension),c(a)}var m,n=a("d3"),o=a("../../core/Bounds"),p={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7},q=[/([MLHVCSQTAZmlhvcsqtaz])/g,/###/,/(\d)-/g,/\s|,|###/],r={},s={},t=Array.prototype.join;return{parse:d,render:i,bounds:j,area:k,line:l}}),f("util/bounds",["require","exports","module","d3","../core/Bounds","../render/canvas/path","./index","./config"],function(a,b,c){function d(){return D||(D=r.select("body").append("canvas").attr("class","vega_hidden").attr("width",1).attr("height",1).style("display","none").node().getContext("2d"))}function e(a,b,c){return null==b?c.set(0,0,0,0):(x(b,c),a.stroke&&0!==a.opacity&&a.strokeWidth>0&&c.expand(a.strokeWidth)),c}function f(a,b){var c=a.path?a.pathCache||(a.pathCache=w(a.path)):null;return e(a,c,b)}function g(a,b){var c=a.mark.items,a=c[0],d=a.pathCache||(a.pathCache=w(y(c)));return e(c[0],d,b)}function h(a,b){var c=a.mark.items,a=c[0],d=a.pathCache||(a.pathCache=w(z(c)));

return e(c[0],d,b)}function i(a,b){var c=a.x||0,d=a.y||0,e=c+a.width||0,f=d+a.height||0;return b.set(c,d,e,f),a.stroke&&0!==a.opacity&&a.strokeWidth>0&&b.expand(a.strokeWidth),b}function j(a,b){var c=a.width||0,d=a.height||0,e=(a.x||0)-("center"===a.align?c/2:"right"===a.align?c:0),f=(a.y||0)-("middle"===a.baseline?d/2:"bottom"===a.baseline?d:0);return b.set(e,f,e+c,f+d)}function k(a,b){var c,d;return b.set(c=a.x||0,d=a.y||0,null!=a.x2?a.x2:c,null!=a.y2?a.y2:d),a.stroke&&0!==a.opacity&&a.strokeWidth>0&&b.expand(a.strokeWidth),b}function l(a,b){var c,d,e,f,g,h,i,j,k,l=a.x||0,m=a.y||0,n=a.innerRadius||0,o=a.outerRadius||0,p=(a.startAngle||0)-A,q=(a.endAngle||0)-A,r=1/0,s=-(1/0),t=1/0,u=-(1/0),v=[p,q],w=p-p%A;for(d=0;4>d&&q>w;++d,w+=A)v.push(w);for(d=0,e=v.length;e>d;++d)c=v[d],f=Math.cos(c),h=n*f,j=o*f,g=Math.sin(c),i=n*g,k=o*g,r=Math.min(r,h,j),s=Math.max(s,h,j),t=Math.min(t,i,k),u=Math.max(u,i,k);return b.set(l+r,m+t,l+s,m+u),a.stroke&&0!==a.opacity&&a.strokeWidth>0&&b.expand(a.strokeWidth),b}function m(a,b){var c,d,e,f,g=null!=a.size?a.size:100,h=a.x||0,i=a.y||0;switch(a.shape){case"cross":c=Math.sqrt(g/5)/2,d=3*c,b.set(h-d,i-c,h+d,i+c);break;case"diamond":f=Math.sqrt(g/(2*C)),e=f*C,b.set(h-e,i-f,h+e,i+f);break;case"square":d=Math.sqrt(g),c=d/2,b.set(h-c,i-c,h+c,i+c);break;case"triangle-down":e=Math.sqrt(g/B),f=e*B/2,b.set(h-e,i-f,h+e,i+f);break;case"triangle-up":e=Math.sqrt(g/B),f=e*B/2,b.set(h-e,i-f,h+e,i+f);break;default:c=Math.sqrt(g/Math.PI),b.set(h-c,i-c,h+c,i+c)}return a.stroke&&0!==a.opacity&&a.strokeWidth>0&&b.expand(a.strokeWidth),b}function n(a,b,c){var e,f,g=(a.x||0)+(a.dx||0),h=(a.y||0)+(a.dy||0),i=a.fontSize||v.render.fontSize,j=a.align,k=a.baseline,l=a.radius||0,m=d();return m.font=u.fontString(a),m.textAlign=j||"left",m.textBaseline=k||"alphabetic",e=m.measureText(a.text||"").width,l&&(f=(a.theta||0)-Math.PI/2,g+=l*Math.cos(f),h+=l*Math.sin(f)),"center"===j?g-=e/2:"right"===j&&(g-=e),"top"===k?h+=i/5:"bottom"===k?h-=i:"middle"===k?h=h-i/2+i/10:h-=4*i/5,b.set(g,h,g+e,h+i),a.angle&&!c&&b.rotate(a.angle*Math.PI/180,a.x||0,a.y||0),b.expand(c?0:1)}function o(a,b,c){var d,e,f=a.axisItems||[],g=a.legendItems||[];for(d=0,e=f.length;e>d;++d)b.union(f[d].bounds);for(d=0,e=a.items.length;e>d;++d)b.union(a.items[d].bounds);if(c){for(d=0,e=g.length;e>d;++d)b.union(g[d].bounds);null!=a.width&&null!=a.height&&b.add(a.width,a.height),null!=a.x&&null!=a.y&&b.add(0,0)}return b.translate(a.x||0,a.y||0),b}function p(a,b,c){b=b||E[a.mark.marktype],a.bounds_prev||(a["bounds:prev"]=new s);var d=a.bounds,e=a["bounds:prev"];return d&&e.clear().union(d),a.bounds=b(a,d?d.clear():new s,c),d||e.clear().union(a.bounds),a.bounds}function q(a,b,c){b=b||a.bounds&&a.bounds.clear()||new s;var d,e,f=a.marktype,g=E[f],h=a.items;if("area"===f||"line"===f)h.length&&(h[0].bounds=g(h[0],b));else for(d=0,e=h.length;e>d;++d)b.union(p(h[d],g,c));a.bounds=b}var r=a("d3"),s=a("../core/Bounds"),t=a("../render/canvas/path"),u=a("./index"),v=a("./config"),w=t.parse,x=t.bounds,y=t.area,z=t.line,A=Math.PI/2,B=Math.sqrt(3),C=Math.tan(30*Math.PI/180),D=null,E={group:o,symbol:m,image:j,rect:i,rule:k,arc:l,text:n,path:f,area:g,line:h};return{mark:q,item:p,text:n,group:o}}),f("scene/Bounder",["require","exports","module","../dataflow/Node","../util/bounds","../util/constants","../util/index"],function(a,b,c){function d(a,b){return this._mark=b,e.prototype.init.call(this,a.graph).router(!0)}var e=a("../dataflow/Node"),f=a("../util/bounds"),g=a("../util/constants"),h=a("../util/index"),i=d.prototype=new e;return i.evaluate=function(a){return h.debug(a,["bounds",this._mark.marktype]),f.mark(this._mark),this._mark.marktype===g.GROUP&&f.mark(this._mark,null,!1),a.reflow=!0,a},d}),f("scene/Item",["require","exports","module"],function(a,b,c){function d(a){this.mark=a}var e=d.prototype;return e.hasPropertySet=function(a){var b=this.mark.def.properties;return b&&null!=b[a]},e.cousin=function(a,b){if(0===a)return this;a=a||-1;var c=this.mark,d=c.group,e=null==b?c.items.indexOf(this):b,f=d.items.indexOf(c)+a;return d.items[f].items[e]},e.sibling=function(a){if(0===a)return this;a=a||-1;var b=this.mark,c=b.items.indexOf(this)+a;return b.items[c]},e.remove=function(){var a=this,b=a.mark.items,c=b.indexOf(a);return c>=0&&(c===b.length-1?b.pop():b.splice(c,1)),a},e.touch=function(){this.pathCache&&(this.pathCache=null),this.mark.pathCache&&(this.mark.pathCache=null)},d}),f("parse/expr",["require","exports","module","../util/index"],function(a,b,c){function d(a,b){var c,d,i,j,k,l,m,n=b.split(h),o={},p={};for(k=0,l=0,i=0,j=n.length;j>i;++i){var c=n[i];"'"!==c?'"'!==c?l||k||(f[c]&&(n[i]=f[c]),g[c]&&(d=n[i+1])&&"("===d[0]&&(n[i]=g[c]),":"==n[i+1]&&(m=c+":"+n[i+2],a.signal((m=e.field(m))[0])&&(o[m[0]]=1,d=e.field(n[i+2]),n[i]="sg['"+n[i],n[i+2]=n[i+2].replace(d[0],d[0]+"']"),i+=2)),a.signal((d=e.field(c))[0])&&(o[d[0]]=1,n[i]=n[i].replace(d[0],"sg["+e.str(d[0])+"]")),"d"==d[0]&&(d=d.splice(1),p[d[0]]=1,d.length>1&&(p[d.join(".")]=1))):k||(l=!l):l||(k=!k)}return{fn:Function("d","e","i","p","sg","return ("+n.join("")+");"),signals:e.keys(o),fields:e.keys(p)}}var e=a("../util/index"),f={E:"Math.E",LN2:"Math.LN2",LN10:"Math.LN10",LOG2E:"Math.LOG2E",LOG10E:"Math.LOG10E",PI:"Math.PI",SQRT1_2:"Math.SQRT1_2",SQRT2:"Math.SQRT2"},g={abs:"Math.abs",acos:"Math.acos",asin:"Math.asin",atan:"Math.atan",atan2:"Math.atan2",ceil:"Math.ceil",cos:"Math.cos",exp:"Math.exp",floor:"Math.floor",log:"Math.log",max:"Math.max",min:"Math.min",pow:"Math.pow",random:"Math.random",round:"Math.round",sin:"Math.sin",sqrt:"Math.sqrt",tan:"Math.tan",date:"Date.parse"},h=/([\"\']|[\=\<\>\~\&\|\?\:\+\-\/\*\%\!\^\,\;\[\]\{\}\(\) ]+)/;return d.eval=function(a,b,c,d,f,g,h){return h=a.signalValues(e.array(h)),b.call(null,c,d,f,g,h)},d}),f("transforms/Parameter",["require","exports","module","../parse/expr","../util/index","../util/constants"],function(a,b,c){function d(a,b){this._name=a,this._type=b,this._value=[],this._accessors=[],this._resolution=!1,this._signals={}}var e=a("../parse/expr"),f=a("../util/index"),g=a("../util/constants"),h=/array/i,i=/data/i,j=/field/i,k=/expr/i,l=d.prototype;return l._get=function(){var a=h.test(this._type),b=i.test(this._type),c=j.test(this._type);return b?a?{names:this._value,sources:this._accessors}:{name:this._value[0],source:this._accessors[0]}:c?a?{fields:this._value,accessors:this._accessors}:{field:this._value[0],accessor:this._accessors[0]}:a?this._value:this._value[0]},l.get=function(a){var b,c,d,e=i.test(this._type),g=j.test(this._type);if(!this._resolution)return this._get();if(e)return this._accessors=this._value.map(function(b){return a.data(b)}),this._get();for(b in this._signals)c=this._signals[b],d=a.signalRef(b),g&&(this._accessors[c]=this._value[c]!=d?f.accessor(d):this._accessors[c]),this._value[c]=d;return this._get()},l.set=function(a,b){var c=this,d=k.test(this._type),h=i.test(this._type),l=j.test(this._type);return this._value=f.array(b).map(function(b,i){if(f.isString(b)){if(d){var j=e(a._graph,b);return a.dependency(g.FIELDS,j.fields),a.dependency(g.SIGNALS,j.signals),j.fn}return l?(c._accessors[i]=f.accessor(b),a.dependency(g.FIELDS,b)):h&&(c._resolution=!0,a.dependency(g.DATA,b)),b}return void 0!==b.value?b.value:void 0!==b.field?(c._accessors[i]=f.accessor(b.field),a.dependency(g.FIELDS,b.field),b.field):void 0!==b.signal?(c._resolution=!0,c._signals[b.signal]=i,a.dependency(g.SIGNALS,b.signal),b.signal):b}),a},d}),f("transforms/Transform",["require","exports","module","../dataflow/Node","./Parameter","../util/index","../util/constants"],function(a,b,c){function d(a){return a&&e.prototype.init.call(this,a),this}var e=a("../dataflow/Node"),f=a("./Parameter"),g=(a("../util/index"),a("../util/constants"));d.addParameters=function(a,b){var c;for(var d in b)c=b[d],a[d]=new f(d,c.type),c["default"]&&a[d].set(a,c["default"]);a._parameters=b};var h=d.prototype=new e;return h.clone=function(){var a=e.prototype.clone.call(this);a.transform=this.transform,a._parameters=this._parameters;for(var b in this)a[b]||(a[b]=this[b]);return a},h.transform=function(a,b){return a},h.evaluate=function(a){var b=this._stamp<a.stamp&&this.dependency(g.SIGNALS).some(function(b){return!!a.signals[b]});return this.transform(a,b)},h.output=function(a){for(var b in this._output)void 0!==a[b]&&(this._output[b]=a[b]);return this},d}),f("util/bins",["require","exports","module"],function(a,b,c){function d(a,b){for(var c=0,d=a.length;d>c;){var e=c+d>>>1;a[e]<b?c=e+1:d=e}return c}function e(a){a=a||{};var b,c,e,f,g=a.maxbins||1024,h=a.base||10,i=a.div||[5,2],j=a.minstep||0,k=Math.log(h),l=Math.ceil(Math.log(g)/k),m=a.min,n=a.max,o=n-m,p=Math.max(j,Math.pow(h,Math.round(Math.log(o)/k)-l)),q=Math.ceil(o/p);if(null!=a.step)p=a.step;else if(a.steps)e=d(a.steps,o/g),e===a.steps.length&&--e,p=a.steps[e];else{do p*=h,q=Math.ceil(o/p);while(q>g);for(e=0;e<i.length;++e)c=p/i[e],c>=j&&g>=o/c&&(p=c,q=Math.ceil(o/p))}return c=Math.log(p),b=c>=0?0:~~(-c/k)+1,f=(0>m?-1:1)*Math.pow(h,-b-1),m=Math.min(m,Math.floor(m/p+f)*p),n=Math.ceil(n/p)*p,{start:m,stop:n,step:p,unit:b}}return e}),f("transforms/Bin",["require","exports","module","./Transform","../util/index","../util/bins","../dataflow/tuple"],function(a,b,c){function d(a){return e.prototype.init.call(this,a),e.addParameters(this,{on:{type:"field"},min:{type:"value"},max:{type:"value"},step:{type:"value"},maxbins:{type:"value","default":20}}),this._output={bin:"bin"},this}var e=a("./Transform"),f=(a("../util/index"),a("../util/bins")),g=a("../dataflow/tuple"),h=d.prototype=new e;return h.transform=function(a){function b(b){var f=c.on.get().accessor(b);f=null==f?null:e.start+e.step*~~((f-e.start)/e.step),g.set(b,d,f,a.stamp)}var c=this,d=this._output.bin,e=f({min:this.min.get(),max:this.max.get(),step:this.step.get(),maxbins:this.maxbins.get()});return a.add.forEach(b),a.mod.forEach(b),a.rem.forEach(b),a},d}),f("transforms/Cross",["require","exports","module","./Transform","../dataflow/Collector","../util/index","../dataflow/tuple","../dataflow/changeset"],function(a,b,c){function d(a){return j.prototype.init.call(this,a),j.addParameters(this,{"with":{type:"data"},diagonal:{type:"value","default":"true"}}),this._output={left:"a",right:"b"},this._collector=new k(a),this._lastRem=null,this._lastWith=null,this._ids={},this._cache={},this.router(!0)}function e(a,b){var c=this._cache[a._id]=this._cache[a._id]||{c:[],s:this._stamp};c.c.push(b)}function f(a,b,c,d,f){for(var g,h,i,j=b?c:this._collector.data(),k=0,l=j.length,n=void 0!==f._prev?null:void 0;l>k;++k)h=j[k],i=b?f._id+"_"+h._id:h._id+"_"+f._id,this._ids[i]||(f._id!=h._id||d)&&(g=m.ingest({},n),g[this._output.left]=b?f:h,g[this._output.right]=b?h:f,a.add.push(g),e.call(this,f,g),e.call(this,h,g),this._ids[i]=1)}function g(a,b,c){var d=this,e=this._cache[c._id];this._lastRem>e.s&&(e.c=e.c.filter(function(a){var c=a[d._output[b?"right":"left"]];return null!==d._cache[c._id]}),e.s=this._lastRem),a.mod.push.apply(a.mod,e.c)}function h(a,b){a.rem.push.apply(a.rem,this._cache[b._id].c),this._cache[b._id]=null,this._lastRem=this._stamp}function i(a,b){(a.add.length||a.rem.length)&&(b.fields[this._output.left]=1,b.fields[this._output.right]=1)}var j=a("./Transform"),k=a("../dataflow/Collector"),l=a("../util/index"),m=a("../dataflow/tuple"),n=a("../dataflow/changeset"),o=d.prototype=new j;return o.transform=function(a){l.debug(a,["crossing"]),this._collector.evaluate(a);var b=this["with"].get(this._graph),c=this.diagonal.get(this._graph),d=!b.name,e=this._collector.data(),j=d?a:b.source.last(),k=d?e:b.source.values(),m=n.create(a),o=h.bind(this,m);return a.rem.forEach(o),a.add.forEach(f.bind(this,m,!0,k,c)),!d&&j.stamp>this._lastWith&&(j.rem.forEach(o),j.add.forEach(f.bind(this,m,!1,e,c)),j.mod.forEach(g.bind(this,m,!1)),i.call(this,j,m),this._lastWith=j.stamp),a.mod.forEach(g.bind(this,m,!0)),i.call(this,a,m),m},d}),f("transforms/Aggregate",["require","exports","module","./Transform","../dataflow/tuple","../dataflow/changeset","../util/index","../util/constants"],function(a,b,c){function d(a){return a&&this.init(a),this}var e=a("./Transform"),f=a("../dataflow/tuple"),g=a("../dataflow/changeset"),h=(a("../util/index"),a("../util/constants")),i=d.prototype=new e;return i.init=function(a){return this._refs=[],this._cells={},e.prototype.init.call(this,a).router(!0).revises(!0)},i.data=function(){return this._cells},i._reset=function(a,b){var c,d;for(c in this._cells)(d=this._cells[c])&&b.rem.push(d.tpl);this._cells={}},i._keys=function(a){var b,c=this._refs.reduce(function(c,d){return void 0!==(b=d(a))?(c.push(b),c):c},[]),d=c.join("|");return c.length>0?{keys:c,key:d}:void 0},i._cell=function(a){var b=this._keys(a);return this._cells[b.key]||(this._cells[b.key]=this._new_cell(a,b))},i._new_cell=function(a,b){return{cnt:0,tpl:this._new_tuple(a,b),flg:h.ADD_CELL}},i._new_tuple=function(a,b){return f.derive(null,null)},i._add=function(a){var b=this._cell(a);return b.cnt+=1,b.flg|=h.MOD_CELL,b},i._rem=function(a){var b=this._cell(a);return b.cnt-=1,b.flg|=h.MOD_CELL,b},i._mod=function(a,b){return a._prev&&a._prev!==h.SENTINEL&&void 0!==this._keys(a._prev)?(this._rem(a._prev),this._add(a)):b?this._add(a):this._cell(a)},i.transform=function(a,b){var c,d,e,f,i=this,j=g.create(a);b&&this._reset(a,j),a.add.forEach(function(a){i._add(a)}),a.mod.forEach(function(a){i._mod(a,b)}),a.rem.forEach(function(a){i._rem(a._prev&&a._prev!==h.SENTINEL&&void 0!==i._keys(a._prev)?a._prev:a)});for(c in this._cells)d=this._cells[c],d&&(e=d.flg,f=d.tpl,0===d.cnt?(e===h.MOD_CELL&&j.rem.push(f),this._cells[c]=null):e&h.ADD_CELL?j.add.push(f):e&h.MOD_CELL&&j.mod.push(f),d.flg=0);return j},d}),f("transforms/Facet",["require","exports","module","./Transform","./Aggregate","../dataflow/tuple","../dataflow/changeset","../util/index","../util/constants"],function(a,b,c){function d(a){return f.prototype.init.call(this,a),e.addParameters(this,{keys:{type:"array<field>"}}),this._pipeline=[],this}var e=a("./Transform"),f=a("./Aggregate"),g=a("../dataflow/tuple"),h=a("../dataflow/changeset"),i=a("../util/index"),j=a("../util/constants"),k=d.prototype=new f;return k.pipeline=function(a){return arguments.length?(this._pipeline=a,this):this._pipeline},k._reset=function(a,b){var c,d;for(c in this._cells)d=this._cells[c],d&&(b.rem.push(d.tpl),d["delete"]());this._cells={}},k._new_tuple=function(a,b){return g.ingest(b,null)},k._new_cell=function(a,b){var c=f.prototype._new_cell.call(this,a,b),d=this._pipeline.map(function(a){return a.clone()}),e=this,g=c.tpl;return c.ds=this._graph.data("vg_"+g._id,d,g),c["delete"]=function(){i.debug({},["deleting cell",b.key]),e.removeListener(d[0]),e._graph.disconnect(d)},this.addListener(d[0]),c},k._add=function(a){var b=f.prototype._add.call(this,a);return b.ds._input.add.push(a),b},k._mod=function(a,b){var c=f.prototype._mod.call(this,a,b);return c.flg&j.ADD_CELL||c.ds._input.mod.push(a),c.flg|=j.MOD_CELL,c},k._rem=function(a){var b=f.prototype._rem.call(this,a);return b.ds._input.rem.push(a),b},k.transform=function(a,b){i.debug(a,["faceting"]),this._refs=this.keys.get(this._graph).accessors;var c,d,e=f.prototype.transform.call(this,a,b);for(c in this._cells)d=this._cells[c],null!=d&&(0===d.cnt?d["delete"]():h.copy(a,d.ds._input));return e},d}),f("transforms/Filter",["require","exports","module","./Transform","../dataflow/changeset","../parse/expr","../util/index","../util/constants"],function(a,b,c){function d(a){return f.prototype.init.call(this,a),f.addParameters(this,{test:{type:"expr"}}),this._skip={},this}function e(a){return h.eval(this._graph,this.test.get(this._graph),a,null,null,null,this.dependency(j.SIGNALS))}var f=a("./Transform"),g=a("../dataflow/changeset"),h=a("../parse/expr"),i=a("../util/index"),j=a("../util/constants"),k=d.prototype=new f;return k.transform=function(a){i.debug(a,["filtering"]);var b=g.create(a),c=this._skip,d=this;return a.rem.forEach(function(a){1!==c[a._id]?b.rem.push(a):c[a._id]=0}),a.add.forEach(function(a){e.call(d,a)?b.add.push(a):c[a._id]=1}),a.mod.forEach(function(a){var f=e.call(d,a),g=1===c[a._id];f&&g?(c[a._id]=0,b.add.push(a)):f&&!g?b.mod.push(a):!f&&g||(b.rem.push(a),c[a._id]=1)}),b},d}),f("transforms/Fold",["require","exports","module","./Transform","../util/index","../dataflow/tuple","../dataflow/changeset"],function(a,b,c){function d(a){return h.prototype.init.call(this,a),h.addParameters(this,{on:{type:"array<field>"}}),this._output={key:"key",value:"value"},this._cache={},this.router(!0).revises(!0)}function e(a,b){for(var c in this._cache)b.rem.push.apply(b.rem,this._cache[c]);this._cache={}}function f(a,b,c){var d=this._cache[a._id]||(this._cache[a._id]=Array(c));return d[b]||(d[b]=j.derive(a,a._prev))}function g(a,b,c,d,e){for(var g,h,i,k=0,l=a.length,m=b.length;l>k;++k)for(h=a[k],g=0;m>g;++g)i=f.call(this,h,g,m),j.set(i,this._output.key,b[g]),j.set(i,this._output.value,c[g](h)),d.push(i)}var h=a("./Transform"),i=a("../util/index"),j=a("../dataflow/tuple"),k=a("../dataflow/changeset"),l=d.prototype=new h;return l.transform=function(a,b){i.debug(a,["folding"]);var c=this,d=this.on.get(this._graph),f=d.fields,h=d.accessors,j=k.create(a);return b&&e.call(this,a,j),g.call(this,a.add,f,h,j.add,a.stamp),g.call(this,a.mod,f,h,b?j.add:j.mod,a.stamp),a.rem.forEach(function(a){j.rem.push.apply(j.rem,c._cache[a._id]),c._cache[a._id]=null}),(a.add.length||a.rem.length||f.some(function(b){return!!a.fields[b]}))&&(j.fields[this._output.key]=1,j.fields[this._output.value]=1),j},d}),f("transforms/Formula",["require","exports","module","./Transform","../dataflow/tuple","../parse/expr","../util/index","../util/constants"],function(a,b,c){function d(a){return e.prototype.init.call(this,a),e.addParameters(this,{field:{type:"value"},expr:{type:"expr"}}),this}var e=a("./Transform"),f=a("../dataflow/tuple"),g=a("../parse/expr"),h=a("../util/index"),i=a("../util/constants"),j=d.prototype=new e;return j.transform=function(a){function b(a){var b=g.eval(c,e,a,null,null,null,j);f.set(a,d,b)}h.debug(a,["formulating"]);var c=this._graph,d=this.field.get(c),e=this.expr.get(c),j=this.dependency(i.SIGNALS);return a.add.forEach(b),this.reevaluate(a)&&a.mod.forEach(b),a.fields[d]=1,a},d}),f("transforms/Sort",["require","exports","module","./Transform","../parse/expr","../util/index"],function(a,b,c){function d(a){return e.prototype.init.call(this,a),e.addParameters(this,{by:{type:"array<field>"}}),this.router(!0)}var e=a("./Transform"),f=(a("../parse/expr"),a("../util/index")),g=d.prototype=new e;return g.transform=function(a){return f.debug(a,["sorting"]),(a.add.length||a.mod.length||a.rem.length)&&(a.sort=f.comparator(this.by.get(this._graph).fields)),a},d}),f("transforms/Stack",["require","exports","module","./Transform","../dataflow/Collector","../util/index","../dataflow/tuple","../dataflow/changeset"],function(a,b,c){function d(a){return f.prototype.init.call(this,a),f.addParameters(this,{groupby:{type:"array<field>"},sortby:{type:"array<field>"},value:{type:"field"},offset:{type:"value","default":"zero"}}),this._output={start:"y2",stop:"y",mid:"cy"},this._collector=new g(a),this.router(!0)}function e(a,b,c,d){var e,f,g,h,i,j,k,l=[];if(null==b)l.push(a.slice());else for(e={},f=0;f<a.length;++f)g=a[f],h=b.map(function(a){return a(g)}),i=e[h]||(l.push(e[h]=[]),e[h]),i.push(g);for(h=0,k=0;h<l.length;++h){for(i=l[h],f=0,j=0;f<i.length;++f)j+=d(i[f]);i.sum=j,j>k&&(k=j),null!=c&&i.sort(c)}return l.max=k,l}var f=a("./Transform"),g=a("../dataflow/Collector"),h=a("../util/index"),i=a("../dataflow/tuple"),k=(a("../dataflow/changeset"),d.prototype=new f);return k.transform=function(a){this._collector.evaluate(a);for(var b=this._collector.data(),c=this._graph,d=this.groupby.get(c).accessors,f=h.comparator(this.sortby.get(c).fields),g=this.value.get(c).accessor,k=this.offset.get(c),l=this._output,m=e(b,d,f,g),n=0,o=m.max;n<m.length;++n){var n,p,q,r=m[n],s=r.sum,t="center"===k?(o-s)/2:0,u="normalize"===k?1/s:1,v=t,w=0;for(j=0;j<r.length;++j)p=r[j],q=v,w+=g(p),v=u*w+t,i.set(p,l.start,q),i.set(p,l.stop,v),i.set(p,l.mid,.5*(q+v))}return a},d}),f("util/quickselect",["require","exports","module","./index"],function(a,b,c){var d=a("./index");return function(a,b,c){function e(a,c){var d=b[a];b[a]=b[c],b[c]=d}null===b&&(b=[],d.keys(c).forEach(function(a){var d=0,e=c[a];for(a=+a||a;e>d;++d)b.push(a)}));for(var f,g,h,i=0,j=b.length-1;j>i;){for(h=b[a],e(a,j),g=f=i;j>g;++g)b[g]<h&&e(g,f++);if(e(j,f),f===a)break;a>f?i=f+1:j=f-1}return b[a]}}),f("transforms/measures",["require","exports","module","../dataflow/tuple","../util/index","../util/quickselect","../util/constants"],function(a,b,c){function d(a){return function(b){var c=Object.create(a);return c.out=b||a.name,c.idx||(c.idx=0),c}}function e(a){function b(a,c){return(c.req||[]).forEach(function(c){a[c]||b(a,a[c]=l[c]())}),a}var c=a.reduce(b,a.reduce(function(a,b){return a[b.name]=b,a},{})),d=[];for(var e in c)d.push(c[e]);return d.sort(function(a,b){return a.idx-b.idx}),d}function f(a){var b=e(a),c="this.flg = this.ADD; this.tpl = t;",d="",f="",l="var t = this.tpl;";return b.forEach(function(a){c+=a.init,d+=a.add,f+=a.rem}),a.forEach(function(a){l+="this.tuple.set(t,'"+a.out+"',"+a.set+");"}),d+="this.flg |= this.MOD;",f+="this.flg |= this.MOD;",l+="return t;",c=Function("t",c),c.prototype.ADD=k.ADD_CELL,c.prototype.MOD=k.MOD_CELL,c.prototype.add=Function("v",d),c.prototype.rem=Function("v",f),c.prototype.set=Function("stamp",l),c.prototype.mod=g,c.prototype.keys=i.keys,c.prototype.sel=j,c.prototype.tuple=h,c}function g(a,b){void 0!==b&&b!==a&&(this.rem(b),this.add(a))}var h=a("../dataflow/tuple"),i=a("../util/index"),j=a("../util/quickselect"),k=a("../util/constants"),l={count:d({name:"count",init:"this.cnt = 0;",add:"this.cnt += 1;",rem:"this.cnt -= 1;",set:"this.cnt"}),_counts:d({name:"_counts",init:"this.cnts = {};",add:"this.cnts[v] = ++this.cnts[v] || 1;",rem:"this.cnts[v] = --this.cnts[v] < 0 ? 0 : this.cnts[v];",set:"",req:["count"]}),sum:d({name:"sum",init:"this.sum = 0;",add:"this.sum += v;",rem:"this.sum -= v;",set:"this.sum"}),avg:d({name:"avg",init:"this.avg = 0;",add:"var d = v - this.avg; this.avg += d / this.cnt;",rem:"var d = v - this.avg; this.avg -= d / this.cnt;",set:"this.avg",req:["count"],idx:1}),"var":d({name:"var",init:"this.dev = 0;",add:"this.dev += d * (v - this.avg);",rem:"this.dev -= d * (v - this.avg);",set:"this.dev / (this.cnt-1)",req:["avg"],idx:2}),varp:d({name:"varp",init:"",add:"",rem:"",set:"this.dev / this.cnt",req:["var"],idx:3}),stdev:d({name:"stdev",init:"",add:"",rem:"",set:"Math.sqrt(this.dev / (this.cnt-1))",req:["var"],idx:4}),stdevp:d({name:"stdevp",init:"",add:"",rem:"",set:"Math.sqrt(this.dev / this.cnt)",req:["var"],idx:5}),min:d({name:"min",init:"this.min = +Infinity;",add:"this.min = v < this.min ? v : this.min;",rem:"var self = this; this.min = v == this.min ? this.keys(this.cnts).reduce(function(m, v) {    return self.cnts[(v = +v)] > 0 && v < m ? v : m }, +Infinity) : this.min;",set:"this.min",req:["_counts"],idx:6}),max:d({name:"max",init:"this.max = -Infinity;",add:"this.max = v > this.max ? v : this.max;",rem:"var self = this; this.max = v == this.max ? this.keys(this.cnts).reduce(function(m, v) {    return self.cnts[(v = +v)] > 0 && v > m ? v : m }, -Infinity) : this.max;",set:"this.max",req:["_counts"],idx:7}),median:d({name:"median",init:"this.vals = []; ",add:"if(this.vals) this.vals.push(v); ",rem:"this.vals = null;",set:"this.cnt % 2 ? this.sel(~~(this.cnt/2), this.vals, this.cnts) : 0.5 * (this.sel(~~(this.cnt/2)-1, this.vals, this.cnts) + this.sel(~~(this.cnt/2), this.vals, this.cnts))",req:["_counts"],idx:8})};return l.create=f,l}),f("transforms/Stats",["require","exports","module","./Transform","./Aggregate","../dataflow/tuple","../dataflow/changeset","./measures","../util/index","../util/constants"],function(a,b,c){function d(a){return f.prototype.init.call(this,a),e.addParameters(this,{group_by:{type:"array<field>"},on:{type:"field"}}),this._output={count:"count",avg:"avg",min:"min",max:"max",sum:"sum",mean:"mean","var":"var",stdev:"stdev",varp:"varp",stdevp:"stdevp",median:"median"},this._Measures=null,this.__facet=null,this}var e=a("./Transform"),f=a("./Aggregate"),g=a("../dataflow/tuple"),h=(a("../dataflow/changeset"),a("./measures")),i=a("../util/index"),j=a("../util/constants"),k=d.prototype=new f;return k.measures={set:function(a,b){return b.indexOf(j.COUNT)<0&&b.push(j.COUNT),a._Measures=h.create(b.map(function(b){return h[b](a._output[b])})),a}},k._reset=function(a,b){var c,d;for(c in this._cells)(d=this._cells[c])&&(a.facet||b.rem.push(d.set()));this._cells={}},k._keys=function(a){return this.__facet?this.__facet:this._refs.length?f.prototype._keys.call(this,a):{keys:[],key:""}},k._new_cell=function(a,b){var c,d,e=this.group_by.get(this._graph),f=e.fields,h=e.accessors,i=this.__facet||{};if(!this.__facet){for(c=0,d=f.length;d>c;++c)i[f[c]]=h[c](a);i=g.ingest(i,null)}return new this._Measures(i)},k._add=function(a){var b=this.on.get(this._graph).accessor;this._cell(a).add(b(a))},k._rem=function(a){var b=this.on.get(this._graph).accessor;this._cell(a).rem(b(a))},k.transform=function(a,b){i.debug(a,["stats"]),a.facet?this.__facet=a.facet:this._refs=this.group_by.get(this._graph).accessors;var c,d,e=f.prototype.transform.call(this,a,b);if(a.facet)return this._cells[a.facet.key].set(),a;for(c in this._cells)d=this._cells[c],d&&d.set();return e},d}),f("transforms/Unique",["require","exports","module","./Transform","./Aggregate","../dataflow/tuple","../util/index"],function(a,b,c){function d(a){return f.prototype.init.call(this,a),e.addParameters(this,{on:{type:"field"},as:{type:"value"}}),this}var e=a("./Transform"),f=a("./Aggregate"),g=a("../dataflow/tuple"),h=a("../util/index"),i=d.prototype=new f;return i._new_tuple=function(a){var b={},c=this.on.get(this._graph),d=this.as.get(this._graph);return b[d]=c.accessor(a),g.ingest(b,null)},i.transform=function(a,b){return h.debug(a,["uniques"]),this._refs=[this.on.get(this._graph).accessor],f.prototype.transform.call(this,a,b)},d}),f("transforms/Zip",["require","exports","module","./Transform","../dataflow/Collector","../util/index"],function(a,b,c){function d(a){return f.prototype.init.call(this,a),f.addParameters(this,{"with":{type:"data"},as:{type:"value"},key:{type:"field","default":"data"},withKey:{type:"field","default":null},"default":{type:"value"}}),this._map={},this._collector=new g(a),this._lastJoin=0,this.revises(!0)}function e(a){return this._map[a]||(this._map[a]=[])}var f=a("./Transform"),g=a("../dataflow/Collector"),h=a("../util/index"),i=d.prototype=new f;return i.transform=function(a){var b=this["with"].get(this._graph),c=b.source,d=c.last(),f=c.values(),g=this.key.get(this._graph),i=this.withKey.get(this._graph),j=this.as.get(this._graph),k=this["default"].get(this._graph),l=e.bind(this),m={};if(h.debug(a,["zipping",b.name]),i.field)d&&d.stamp>this._lastJoin&&(d.rem.forEach(function(a){var b=l(i.accessor(a));b[0]&&b[0].forEach(function(a){a[j]=k}),b[1]=null}),d.add.forEach(function(a){var b=l(i.accessor(a));b[0]&&b[0].forEach(function(b){b[j]=a}),b[1]=a}),d.fields[i.field]&&d.mod.forEach(function(a){var b;if(a._prev&&void 0!==(b=i.accessor(a._prev))){var c=l(b);c[0]&&c[0].forEach(function(a){a[j]=k}),c[1]=null;var d=l(i.accessor(a));d[0]&&d[0].forEach(function(b){b[j]=a}),d[1]=a}}),this._lastJoin=d.stamp),a.add.forEach(function(a){var b=l(g.accessor(a));a[j]=b[1]||k,(b[0]=b[0]||[]).push(a)}),a.rem.forEach(function(a){var b=g.accessor(a);(m[b]=m[b]||{})[a._id]=1}),a.fields[g.field]&&a.mod.forEach(function(a){var b;if(a._prev&&void 0!==(b=g.accessor(a._prev))){var c=l(g.accessor(a));a[j]=c[1]||k,(c[0]=c[0]||[]).push(a),(m[b]=m[b]||{})[a._id]=1}}),h.keys(m).forEach(function(a){var b=l(a);b[0]&&(b[0]=b[0].filter(function(b){return 1!==m[a][b._id]}))});else{if(0==a.add.length&&0==a.rem.length&&0==d.add.length&&0==d.rem.length)return a;this._collector.evaluate(a);var n,o=this._collector.data(),p=f.length;for(n=0;n<o.length;n++)o[n][j]=f[n%p]}return a.fields[j]=1,a},d}),f("transforms/index",["require","exports","module","./Bin","./Cross","./Facet","./Filter","./Fold","./Formula","./Sort","./Stack","./Stats","./Unique","./Zip"],function(a,b,c){return{bin:a("./Bin"),cross:a("./Cross"),facet:a("./Facet"),filter:a("./Filter"),fold:a("./Fold"),formula:a("./Formula"),sort:a("./Sort"),stack:a("./Stack"),stats:a("./Stats"),unique:a("./Unique"),zip:a("./Zip")}}),f("parse/transforms",["require","exports","module","../util/index","../transforms/index"],function(a,b,c){var d=a("../util/index"),e=a("../transforms/index");return function f(a,b){var c=new e[b.type](a.graph);if("facet"==b.type){var g=(b.transform||[]).map(function(b){return f(a,b)});c.pipeline(g)}return b.output&&c.output(b.output),d.keys(b).forEach(function(a){"type"!==a&&"output"!==a&&("transform"!==a||"facet"!==b.type)&&c[a].set(c,b[a])}),c}}),f("parse/modify",["require","exports","module","../dataflow/Node","../dataflow/tuple","../util/index","../util/constants"],function(a,b,c){var d=a("../dataflow/Node"),e=a("../dataflow/tuple"),f=a("../util/index"),g=a("../util/constants"),h=function(a,b,c,d){for(var e=c.length-1;e>=0;--e)c[e][a]==b&&d.push.apply(d,c.splice(e,1))};return function(a,b,c){var i=a.graph,j=b.signal?f.field(b.signal):null,k=j?j[0]:null,l=b.predicate?a.predicate(b.predicate):null,m=null===l,n=new d(i);return n.evaluate=function(d){if(null!==l){var k={};(l.data||[]).forEach(function(b){k[b]=a.data(b).values()}),m=l({},k,i.signalValues(l.signals||[]),a._predicates)}if(f.debug(d,[b.type+"ing",m]),!m)return d;var n={},o=j?i.signalRef(b.signal):null,p=a.data(c.name),q=p.revises()?null:void 0,r=null;if(n[b.field]=o,b.type==g.ADD)r=e.ingest(n,q),d.add.push(r),p._data.push(r);else if(b.type==g.REMOVE)h(b.field,o,d.add,d.rem),h(b.field,o,d.mod,d.rem),p._data=p._data.filter(function(a){return a[b.field]!==o});else if(b.type==g.TOGGLE){var s=[],t=[];h(b.field,o,d.rem,s),h(b.field,o,d.add,t),h(b.field,o,d.mod,t),0==s.length&&0==t.length&&s.push(e.ingest(n)),d.add.push.apply(d.add,s),p._data.push.apply(p._data,s),d.rem.push.apply(d.rem,t),p._data=p._data.filter(function(a){return-1===t.indexOf(a)})}else b.type==g.CLEAR&&(d.rem.push.apply(d.rem,d.add),d.rem.push.apply(d.rem,d.mod),d.add=[],d.mod=[],p._data=[]);return d.fields[b.field]=1,d},k&&n.dependency(g.SIGNALS,k),l&&n.dependency(g.SIGNALS,l.signals),n}}),f("util/load",["require","exports","module","./index","./config"],function(b,c,d){function e(a){return j.test(a)}function f(b,c){return h.log("LOAD: "+b),g(b)?void a.xhr(b,function(a,b){b&&(b=b.responseText),c(a,b)}):void h.error("URL is not whitelisted: "+b)}function g(a){if(!i.domainWhiteList)return!0;var b=document.createElement("a");b.href=a;var c=b.hostname.toLowerCase();return i.domainWhiteList.some(function(a){return a===c||c.lastIndexOf("."+a)===c.length-a.length-1})}var h=b("./index"),i=b("./config"),j=/^[A-Za-z]+\:\/\//;return function(a,b){var c=e(a)?a:i.baseURL+a;f(c,b)}}),f("util/read",["require","exports","module","./index"],function(c,d,e){function f(a,b){var c=b&&b.type||"json";return a=j[c](a,b),b&&b.parse&&g(a,b.parse),a}function g(a,b){var c=i.keys(b),d=c.map(function(a){return k[b[a]]}),e=i.isTree(a);h(e?[a]:a,c,d,e)}function h(a,b,c,d){var e,f,h,i,j;for(f=0,i=a.length;i>f;++f){for(e=a[f],h=0,j=b.length;j>h;++h)e[b[h]]=c[h](e[b[h]]);d&&e.values&&g(e,b,c,!0)}}var i=c("./index"),j={},k={number:i.number,"boolean":i["boolean"],date:Date.parse};return j.json=function(a,b){var c=i.isObject(a)?a:JSON.parse(a);return b&&b.property&&(c=i.accessor(b.property)(c)),c},j.csv=function(b,c){var d=a.csv.parse(b);return d},j.tsv=function(b,c){var d=a.tsv.parse(b);return d},j.topojson=function(a,c){if(null==b)return i.error("TopoJSON library not loaded."),[];var d=i.isObject(a)?a:JSON.parse(a),e=[];return c&&c.feature?e=(e=d.objects[c.feature])?b.feature(d,e).features:(i.error("Invalid TopoJSON object: "+c.feature),[]):c&&c.mesh?e=(e=d.objects[c.mesh])?[b.mesh(d,d.objects[c.mesh])]:(i.error("Invalid TopoJSON object: "+c.mesh),[]):i.error("Missing TopoJSON feature or mesh parameter."),
e},j.treejson=function(a,b){return a=i.isObject(a)?a:JSON.parse(a),i.tree(a,b.children)},f.formats=j,f.parse=g,f}),f("parse/data",["require","exports","module","./transforms","./modify","../util/index","../util/load","../util/read"],function(a,b,c){var d=a("./transforms"),e=a("./modify"),f=a("../util/index"),g=a("../util/load"),h=a("../util/read"),i=function(a,b,c){function d(b){return function(d,g){d?f.error("LOADING FAILED: "+b.url):a.data(b.name).values(h(g.toString(),b.format)),0===--e&&c()}}var e=0;return(b||[]).forEach(function(b){b.url&&(e+=1,g(b.url,d(b))),i.datasource(a,b)}),0===e&&setTimeout(c,1),b};return i.datasource=function(a,b){var c=(b.transform||[]).map(function(b){return d(a,b)}),f=(b.modify||[]).map(function(c){return e(a,c,b)}),g=a.data(b.name,f.concat(c));return b.values?g.values(h(b.values,b.format)):b.source&&(g.source(b.source).revises(g.revises()).addListener(g),a.removeListener(g.pipeline()[0])),g},i}),f("scene/Builder",["require","exports","module","../dataflow/Node","./Encoder","./Bounder","./Item","../parse/data","../dataflow/tuple","../dataflow/changeset","../util/index","../util/constants"],function(a,b,c){function d(){return arguments.length?this.init.apply(this,arguments):this}function e(){var a,b,c,d,e=this._def.from,f=e.mark;f?(a=["vg",this._parent_id,f].join("_"),b={name:a,transform:e.transform,modify:e.modify}):(a=["vg",this._from,this._def.type,Date.now()].join("_"),b={name:a,source:this._from,transform:e.transform,modify:e.modify}),this._from=a,this._ds=o.datasource(this._model,b);var g=this._ds.revises();if(f)c=this.sibling(f).revises(g),c._isSuper?c.addListener(this._ds.listener()):c._bounder.addListener(this._ds.listener());else{var d=this._ds.source().revises(g).last();input=q.create(d),input.add=d.add,input.mod=d.mod,input.rem=d.rem,input.stamp=null,this._graph.propagate(input,this._ds.listener())}}function f(){var a=this._revises?null:void 0,b=p.ingest(new n(this._mark),a);return this._def.width&&p.set(b,"width",this._def.width),this._def.height&&p.set(b,"height",this._def.height),b}function g(a,b,c,d,e,g){var h,i,j,k,l,m;for(h=0,j=a.length;j>h;++h)l=a[h],k=b?this._map[i=b(l)]:e[h],m=k?!1:(k=f.call(this),!0),k.status=m?s.ENTER:s.UPDATE,k.datum=l,p.set(k,"key",i),this._map[i]=k,c.push(k),m?d.add.push(k):(!g||g&&g[l._id])&&d.mod.push(k)}function h(a,b,c){var d,e,f,h,i=q.create(a),k=j(this._def.key||"_id"),l=(a.add,a.mod),m=a.rem,n=[];for(d=0,f=m.length;f>d;++d)h=this._map[e=k(m[d])],h.status=s.EXIT,n.push(h),i.rem.push(h),this._map[e]=null;return g.call(this,b,k,n,i,null,r.tuple_ids(c?b:l)),this._mark.items=n,i}function i(a,b,c){var d,e,f,h=q.create(a),i=j(this._def.key),k=this._mark.items||[],l=[];for(d=0,e=k.length;e>d;++d)f=k[d],f.status=s.EXIT,i&&(this._map[f.key]=f);for(g.call(this,b,i,l,h,k,c?r.tuple_ids(b):null),d=0,e=k.length;e>d;++d)f=k[d],f.status===s.EXIT&&(p.set(f,"key",i?f.key:this._items.length),l.splice(0,0,f),h.rem.push(f));return this._mark.items=l,h}function j(a){if(null==a)return null;var b=r.array(a).map(r.accessor);return function(a){for(var c="",d=0,e=b.length;e>d;++d)d>0&&(c+="|"),c+=String(b[d](a));return c}}var k=a("../dataflow/Node"),l=a("./Encoder"),m=a("./Bounder"),n=a("./Item"),o=a("../parse/data"),p=a("../dataflow/tuple"),q=a("../dataflow/changeset"),r=a("../util/index"),s=a("../util/constants"),t=d.prototype=new k;return t.init=function(a,b,c,d,f,g){return k.prototype.init.call(this,a.graph).router(!0).collector(!0),this._model=a,this._def=b,this._mark=c,this._from=(b.from?b.from.data:null)||g,this._ds=r.isString(this._from)?a.data(this._from):null,this._map={},this._revises=!1,c.def=b,c.marktype=b.type,c.interactive=!(b.interactive===!1),c.items=[],this._parent=d,this._parent_id=f,b.from&&(b.from.mark||b.from.transform||b.from.modify)&&e.call(this),this._isSuper=this._def.type!==s.GROUP,this._encoder=new l(this._model,this._mark),this._bounder=new m(this._model,this._mark),this._ds&&this._encoder.dependency(s.DATA,this._from),this.dependency(s.DATA,this._encoder.dependency(s.DATA)),this.dependency(s.SCALES,this._encoder.dependency(s.SCALES)),this.dependency(s.SIGNALS,this._encoder.dependency(s.SIGNALS)),this},t.revises=function(a){return arguments.length?(!this._revises&&a&&this._items.forEach(function(a){void 0===a._prev&&(a._prev=s.SENTINEL)}),this._revises=this._revises||a,this):this._revises},t.pipeline=function(){return[this]},t.connect=function(){var a=this;return this._model.graph.connect(this.pipeline()),this._encoder.dependency(s.SCALES).forEach(function(b){a._parent.scale(b).addListener(a)}),this._parent&&(this._isSuper?this.addListener(this._parent._collector):this._bounder.addListener(this._parent._collector)),this},t.disconnect=function(){var a=this;return this._listeners.length?(k.prototype.disconnect.call(this),this._model.graph.disconnect(this.pipeline()),this._encoder.dependency(s.SCALES).forEach(function(b){a._parent.scale(b).removeListener(a)}),this):this},t.sibling=function(a){return this._parent.child(a,this._parent_id)},t.evaluate=function(a){r.debug(a,["building",this._from,this._def.type]);var b,c,d,e;return this._ds?(b=q.create(a),e=r.duplicate(b.data),delete b.data[this._ds.name()],c=this._encoder.reevaluate(b),b.data=e,c&&(b.mod=this._mark.items.slice()),d=this._ds.last(),d?d.stamp>this._stamp&&(b=h.call(this,d,this._ds.values(),c)):b.reflow=!0):(c=this._encoder.reevaluate(a),e=r.isFunction(this._def.from)?this._def.from():[s.SENTINEL],b=i.call(this,a,e,c)),b=this._graph.evaluate(b,this._encoder),this._isSuper?this._graph.evaluate(b,this._bounder):b},d}),f("scene/Scale",["require","exports","module","d3","../dataflow/Node","../transforms/Stats","../dataflow/changeset","../util/index","../util/config","../util/constants"],function(a,b,c){function d(a,b,c){return this._model=a,this._def=b,this._parent=c,this._updated=!1,n.prototype.init.call(this,a.graph)}function e(a){var b=this._def.name,c=b+":prev",d=f.call(this,a.scale(b)),e=d.type===s.ORDINAL?g:h,i=l.call(this,a);return e.call(this,d,i,a),a.scale(b,d),a.scale(c,a.scale(c)||d),d}function f(a){var b=this._def.type||s.LINEAR;if(!a||b!==a.type){var c=r.scale[b]||m.scale[b];c||q.error("Unrecognized scale type: "+b),(a=c()).type=a.type||b,a.scaleName=this._def.name,a._prev={}}return a}function g(a,b,c){var d,e,f=this._def,g=a._prev,h=!1;q.isObject(f.range)&&!q.isArray(f.range)&&(h=!0,b=i.call(this,s.RANGE,f.range,a,c)),d=i.call(this,s.DOMAIN,f.domain,a,c),d&&!q.equal(g.domain,d)&&(a.domain(d),g.domain=d,this._updated=!0),q.equal(g.range,b)||(e="string"==typeof b[0],e||b.length>2||1===b.length||h?a.range(b):f.points?a.rangePoints(b,f.padding||0):f.round||void 0===f.round?a.rangeRoundBands(b,f.padding||0):a.rangeBands(b,f.padding||0),g.range=b,this._updated=!0)}function h(a,b,c){var d,e,f=this._def,g=a._prev;d=f.type===s.QUANTILE?i.call(this,s.DOMAIN,f.domain,a,c):k.call(this,a,c),d&&!q.equal(g.domain,d)&&(a.domain(d),g.domain=d,this._updated=!0),"height"===f.range&&(b=b.reverse()),q.equal(g.range,b)||(a[f.round&&a.rangeRound?"rangeRound":"range"](b),g.range=b,this._updated=!0,this._stamp>0||(f.exponent&&f.type===s.POWER&&a.exponent(f.exponent),f.clamp&&a.clamp(!0),f.nice&&(f.type===s.TIME?(e=m.time[f.nice],e||q.error("Unrecognized interval: "+e),a.nice(e)):a.nice())))}function i(a,b,c,d){if(q.isArray(b))return b.map(j.bind(this));var e,f,g,h,i,k,l,m,n,p,r=this,t=this._graph,u=b.fields||q.array(b),v=c.type===s.ORDINAL||c.type===s.QUANTILE,w="_"+a,x=c[w],y=b.sort;for(x||(x=c[w]=new o(t),l=[],v&&y?l.push(y.stat):v||l.push(s.MIN,s.MAX),x.measures.set(x,l)),e=0,f=u.length;f>e;++e)if(i=u[e],m=i.data||"vg_"+d.datum._id,n=t.data(m).revises(!0).last(),!(n.stamp<=this._stamp)){if(k=q.array(i.field).map(function(a){return a.group?q.accessor(a.group)(d.datum):a}),v)for(x.on.set(x,y?y.field:"_id"),g=0,h=k.length;h>g;++g)x.group_by.set(x,k[g]).evaluate(n);else for(g=0,h=k.length;h>g;++g)x.on.set(x,k[g]).evaluate(n);this.dependency(s.DATA,m),x.dependency(s.SIGNALS).forEach(function(a){r.dependency(s.SIGNALS,a)})}return n=x.data(),v?(p=q.keys(n).filter(function(a){return null!=n[a]}),y&&(y=y.order.signal?t.signalRef(y.order.signal):y.order,y=(y==s.DESC?"-":"+")+"tpl."+x.on.get(t).field,y=q.comparator(y),p=p.map(function(a){return{key:a,tpl:n[a].tpl}}).sort(y).map(function(a){return a.key})),p):(n=n[""],null==n?[]:[n.tpl.min,n.tpl.max])}function j(a){var b,c=a.signal;return c?(this.dependency(s.SIGNALS,(b=q.field(c))[0]),this._graph.signalRef(b)):a}function k(a,b){var c,d=this._def,e=[null,null];return void 0!==d.domain&&(e=q.isObject(d.domain)?i.call(this,s.DOMAIN,d.domain,a,b):e),c=e.length-1,void 0!==d.domainMin&&(e[0]=q.isObject(d.domainMin)?d.domainMin.signal?j.call(this,d.domainMin):i.call(this,s.DOMAIN+s.MIN,d.domainMin,a,b)[0]:d.domainMin),void 0!==d.domainMax&&(e[c]=q.isObject(d.domainMax)?d.domainMax.signal?j.call(this,d.domainMax):i.call(this,s.DOMAIN+s.MAX,d.domainMax,a,b)[1]:d.domainMax),d.type===s.LOG||d.type===s.TIME||!d.zero&&void 0!==d.zero||(e[0]=Math.min(0,e[0]),e[c]=Math.max(0,e[c])),e}function l(a){var b=this._def,c=[null,null];if(void 0!==b.range)if("string"==typeof b.range)if(t[b.range])c=[0,a[b.range]];else{if(!r.range[b.range])return q.error("Unrecogized range: "+b.range),c;c=r.range[b.range]}else if(q.isArray(b.range))c=b.range.map(j.bind(this));else{if(q.isObject(b.range))return null;c=[0,b.range]}if(void 0!==b.rangeMin&&(c[0]=b.rangeMin.signal?j.call(this,b.rangeMin):b.rangeMin),void 0!==b.rangeMax&&(c[c.length-1]=b.rangeMax.signal?j.call(this,b.rangeMax):b.rangeMax),void 0!==b.reverse){var d=b.reverse;q.isObject(d)&&(d=q.accessor(d.field)(a.datum)),d&&(c=c.reverse())}return c}var m=a("d3"),n=a("../dataflow/Node"),o=a("../transforms/Stats"),p=a("../dataflow/changeset"),q=a("../util/index"),r=a("../util/config"),s=a("../util/constants"),t={width:1,height:1},u=d.prototype=new n;return u.evaluate=function(a){var b=this,c=function(a){e.call(b,a)};return this._updated=!1,a.add.forEach(c),a.mod.forEach(c),this._updated&&(a.scales[this._def.name]=1),p.create(a,!0)},u.dependency=function(a,b){if(2==arguments.length){b=q.array(b);for(var c=0,d=b.length;d>c;++c)this._graph[a==s.DATA?s.DATA:s.SIGNAL](b[c]).addListener(this._parent)}return n.prototype.dependency.call(this,a,b)},d}),f("parse/properties",["require","exports","module","d3","../dataflow/tuple","../util/index","../util/config"],function(a,b,c){function d(a,b,c){var d,h,l,m,n="",o=k.keys(c),p={},q={signals:{},scales:{},data:{}};for(n+="var o = trans ? {} : item;\n",d=0,h=o.length;h>d;++d)m=c[l=o[d]],n+=d>0?"\n  ":"  ",m.rule?(m=f(a,l,m.rule),n+="\n  "+m.code):(m=g(l,m),n+="this.tpl.set(o, "+k.str(l)+", "+m.val+");"),p[l]=!0,["signals","scales","data"].forEach(function(a){null!=m[a]&&k.array(m[a]).forEach(function(b){q[a][b]=1})});p.x2&&(p.x?(n+="\n  if (o.x > o.x2) { var t = o.x;this.tpl.set(o, 'x', o.x2);this.tpl.set(o, 'x2', t); };",n+="\n  this.tpl.set(o, 'width', (o.x2 - o.x));"):n+=p.width?"\n  this.tpl.set(o, 'x', (o.x2 - o.width));":"\n  this.tpl.set(o, 'x', o.x2);"),p.y2&&(p.y?(n+="\n  if (o.y > o.y2) { var t = o.y;this.tpl.set(o, 'y', o.y2);this.tpl.set(o, 'y2', t);};",n+="\n  this.tpl.set(o, 'height', (o.y2 - o.y));"):n+=p.height?"\n  this.tpl.set(o, 'y', (o.y2 - o.height));":"\n  this.tpl.set(o, 'y', o.y2);"),e(b,p)&&(n+="\n  item.touch();"),n+="\n  if (trans) trans.interpolate(item, o);";try{var r=Function("item","group","trans","db","signals","predicates",n);return r.tpl=j,r.util=k,r.d3=i,{encode:r,signals:k.keys(q.signals),scales:k.keys(q.scales),data:k.keys(q.data)}}catch(s){k.error(s),k.log(n)}}function e(a,b){return b.path||("area"===a||"line"===a)&&(b.x||b.x2||b.width||b.y||b.y2||b.height||b.tension||b.interpolate)}function f(a,b,c){var d=[],e=[],f=[],h=[],i="";return(c||[]).forEach(function(j,l){var m,n=j.predicate,o=a.predicate(n),p=[],q=b+"_arg"+l;k.keys(j.input).forEach(function(a){var b=g(l,j.input[a]);p.push(k.str(a)+": "+b.val),b.signals&&d.push.apply(d,k.array(b.signals)),b.scales&&e.push.apply(e,k.array(b.scales))}),m=g(b,j),m.signals&&d.push.apply(d,k.array(m.signals)),m.scales&&e.push.apply(e,k.array(m.scales)),n?(d.push.apply(d,o.signals),f.push.apply(f,o.data),h.push(q+" = {"+p.join(", ")+"}"),i+="if(predicates["+k.str(n)+"]("+q+", db, signals, predicates)) {\n    this.tpl.set(o, "+k.str(b)+", "+m.val+");\n",i+=c[l+1]?"  } else ":"  }"):i+="{\n    this.tpl.set(o, "+k.str(b)+", "+m.val+");\n  }"}),i="var "+h.join(",\n      ")+";\n  "+i,{code:i,signals:d,scales:e,data:f}}function g(a,b){if(null==b)return null;var c="fill"===a||"stroke"===a,d=[];if(c){if(b.c)return h("hcl",b.h,b.c,b.l);if(b.h||b.s)return h("hsl",b.h,b.s,b.l);if(b.l||b.a)return h("lab",b.l,b.a,b.b);if(b.r||b.g||b.b)return h("rgb",b.r,b.g,b.b)}var e=null,f=null;if(void 0!==b.value&&(e=k.str(b.value)),void 0!==b.signal&&(f=k.field(b.signal),e="signals["+f.map(k.str).join("][")+"]",d.push(f.shift())),null!=b.group){var g="group.datum";k.isString(b.group)&&(g=m[b.group]?"group."+b.group:"group.datum["+k.field(b.group).map(k.str).join("][")+"]")}if(null!=b.field?k.isString(b.field)?(e="item.datum["+k.field(b.field).map(k.str).join("][")+"]",null!=b.group&&(e="this.util.accessor("+e+")("+g+")")):b.field.signal?(f=k.field(b.field.signal),e="item.datum[signals["+f.map(k.str).join("][")+"]]",null!=b.group&&(e="this.util.accessor("+e+")("+g+")"),d.push(f.shift())):e="this.util.accessor(group.datum["+k.field(b.field.group).map(k.str).join("][")+"])(item.datum)":null!=b.group&&(e=g),null!=b.scale){var i=null;k.isString(b.scale)?i=k.str(b.scale):b.scale.signal?(f=k.field(b.scale.signal),i="signals["+f.map(k.str).join("][")+"]",d.push(f.shift())):i=(b.scale.group?"group":"item")+".datum["+k.str(b.scale.group||b.scale.field)+"]",i="group.scale("+i+")",b.invert&&(i+=".invert"),e=null!==e||b.band||b.mult||b.offset?i+(b.band?".rangeBand()":"("+(null!==e?e:"item.datum.data")+")"):i}return e="("+(b.mult?k.number(b.mult)+" * ":"")+e+")"+(b.offset?" + "+k.number(b.offset):""),{val:e,signals:d,scales:b.scale}}function h(a,b,c,d){var e=b?g("",b):l.color[a][0],f=c?g("",c):l.color[a][1],h=d?g("",d):l.color[a][2];return signals=[],scales=[],[e,f,h].forEach(function(a){a.signals&&signals.push.apply(signals,a.signals),a.scales&&scales.push(a.scales)}),{val:"(this.d3."+a+"("+[e.val,f.val,h.val].join(",")+') + "")',signals:signals,scales:scales}}var i=a("d3"),j=a("../dataflow/tuple"),k=a("../util/index"),l=a("../util/config"),m={width:1,height:1,"mark.group.width":1,"mark.group.height":1};return d}),f("parse/mark",["require","exports","module","../util/index","./properties"],function(a,b,c){var d=a("../util/index"),e=a("./properties");return function f(a,b){var c=b.properties,g=b.marks;return d.keys(c).forEach(function(d){c[d]=e(a,b.type,c[d])}),b.delay&&(b.delay=e(a,b.type,{delay:b.delay})),g&&(b.marks=g.map(function(b){return f(a,b)})),b}}),f("scene/axis",["require","exports","module","../util/config","../dataflow/tuple","../util/index","../parse/mark"],function(b,c,d){function e(b){function c(){x.type=null}function d(a){var c,d,e;"ordinal"===a.type?(c={scale:a.scaleName,offset:.5+a.rangeBand()/2},d=c):(c={scale:a.scaleName,offset:.5},d={scale:a.scaleName+":prev",offset:.5}),e=h(a),Q.gridLines||(Q.gridLines=n()),Q.majorTicks||(Q.majorTicks=n()),Q.minorTicks||(Q.minorTicks=n()),Q.tickLabels||(Q.tickLabels=o()),Q.domain||(Q.domain=q()),Q.title||(Q.title=p()),Q.gridLines.properties.enter.stroke={value:r.axis.gridColor},j(g,Q.gridLines,d,c,1/0),j(g,Q.majorTicks,d,c,B),j(g,Q.minorTicks,d,c,C),i(g,Q.tickLabels,d,c,B,E),l(g,Q.domain,e,D),k(g,Q.title,e,w),t.extend(Q.gridLines.properties.update,K),t.extend(Q.majorTicks.properties.update,M),t.extend(Q.minorTicks.properties.update,N),t.extend(Q.tickLabels.properties.update,L),t.extend(Q.domain.properties.update,P),t.extend(Q.title.properties.update,O);var f=[Q.gridLines,Q.majorTicks,Q.minorTicks,Q.tickLabels,Q.domain,Q.title];t.extend(x,{type:"group",interactive:!1,properties:{enter:{encode:m,scales:[a.scaleName],signals:[],data:[]},update:{encode:m,scales:[a.scaleName],signals:[],data:[]}}}),x.marks=f.map(function(a){return u(b,a)})}var e,g=r.axis.orient,s=0,w=r.axis.titleOffset,x={},y="front",z=!1,A=null,B=r.axis.tickSize,C=r.axis.tickSize,D=r.axis.tickSize,E=r.axis.padding,F=null,G=null,H=null,I=0,J=[r.axis.ticks],K={},L={},M={},N={},O={},P={},Q={gridLines:null,majorTicks:null,minorTicks:null,tickLabels:null,domain:null,title:null},R={};return R.def=function(){x.type||d(e),H=G?"time"===e.type?a.time.format(G):a.format(G):null;var b=function(a){return{data:a}},c=null==F?e.ticks?e.ticks.apply(e,J):e.domain():F,h=f(e,c,I).map(b);c=c.map(b);var i=null==H?e.tickFormat?e.tickFormat.apply(e,J):String:H;c.forEach(function(a){a.label=i(a.data)});var j=A?[A].map(b):[];return x.marks[0].from=function(){return z?c:[]},x.marks[1].from=function(){return c},x.marks[2].from=function(){return h},x.marks[3].from=x.marks[1].from,x.marks[4].from=function(){return[1]},x.marks[5].from=function(){return j},x.offset=s,x.orient=g,x.layer=y,x},R.scale=function(a){return arguments.length?(e!==a&&(e=a,c()),R):e},R.orient=function(a){return arguments.length?(g!==a&&(g=a in v?a+"":r.axis.orient,c()),R):g},R.title=function(a){return arguments.length?(A!==a&&(A=a,c()),R):A},R.ticks=function(){return arguments.length?(J=arguments,R):J},R.tickValues=function(a){return arguments.length?(F=a,R):F},R.tickFormat=function(a){return arguments.length?(G!==a&&(G=a,c()),R):G},R.tickSize=function(a,b){if(!arguments.length)return B;var d=arguments.length-1,e=+a,f=d>1?+b:B,g=d>0?+arguments[d]:B;return(B!==e||C!==f||D!==g)&&c(),B=e,C=f,D=g,R},R.tickSubdivide=function(a){return arguments.length?(I=+a,R):I},R.offset=function(a){return arguments.length?(s=t.isObject(a)?a:+a,R):s},R.tickPadding=function(a){return arguments.length?(E!==+a&&(E=+a,c()),R):E},R.titleOffset=function(a){return arguments.length?(w!==+a&&(w=+a,c()),R):w},R.layer=function(a){return arguments.length?(y!==a&&(y=a,c()),R):y},R.grid=function(a){return arguments.length?(z!==a&&(z=a,c()),R):z},R.gridLineProperties=function(a){return arguments.length?(K!==a&&(K=a),R):K},R.majorTickProperties=function(a){return arguments.length?(M!==a&&(M=a),R):M},R.minorTickProperties=function(a){return arguments.length?(N!==a&&(N=a),R):N},R.tickLabelProperties=function(a){return arguments.length?(L!==a&&(L=a),R):L},R.titleProperties=function(a){return arguments.length?(O!==a&&(O=a),R):O},R.domainProperties=function(a){return arguments.length?(P!==a&&(P=a),R):P},R.reset=function(){c()},R}function f(a,b,c){if(d=[],c&&b.length>1){for(var d,e,f,h=g(a.domain()),i=-1,j=b.length,k=(b[1]-b[0])/++c;++i<j;)for(e=c;--e>0;)(f=+b[i]-e*k)>=h[0]&&d.push(f);for(--i,e=0;++e<c&&(f=+b[i]+e*k)<h[1];)d.push(f)}return d}function g(a){var b=a[0],c=a[a.length-1];return c>b?[b,c]:[c,b]}function h(a){return a.rangeExtent?a.rangeExtent():g(a.range())}function i(a,b,c,d,e,f){e=Math.max(e,0)+f,("left"===a||"top"===a)&&(e*=-1),"top"===a||"bottom"===a?(t.extend(b.properties.enter,{x:c,y:{value:e}}),t.extend(b.properties.update,{x:d,y:{value:e},align:{value:"center"},baseline:{value:x[a]}})):(t.extend(b.properties.enter,{x:{value:e},y:c}),t.extend(b.properties.update,{x:{value:e},y:d,align:{value:w[a]},baseline:{value:"middle"}}))}function j(a,b,c,d,e){var f="left"===a||"top"===a?-1:1;e=e===1/0?"top"===a||"bottom"===a?{group:"mark.group.height",mult:-f}:{group:"mark.group.width",mult:-f}:{value:f*e},"top"===a||"bottom"===a?(t.extend(b.properties.enter,{x:c,y:{value:0},y2:e}),t.extend(b.properties.update,{x:d,y:{value:0},y2:e}),t.extend(b.properties.exit,{x:d})):(t.extend(b.properties.enter,{x:{value:0},x2:e,y:c}),t.extend(b.properties.update,{x:{value:0},x2:e,y:d}),t.extend(b.properties.exit,{y:d}))}function k(a,b,c,d){var e=~~((c[0]+c[1])/2),f="top"===a||"left"===a?-1:1;"bottom"===a||"top"===a?t.extend(b.properties.update,{x:{value:e},y:{value:f*d},angle:{value:0}}):t.extend(b.properties.update,{x:{value:f*d},y:{value:e},angle:{value:-90}})}function l(a,b,c,d){var e;("top"===a||"left"===a)&&(d=-1*d),e="bottom"===a||"top"===a?"M"+c[0]+","+d+"V0H"+c[1]+"V"+d:"M"+d+","+c[0]+"H0V"+c[1]+"H"+d,b.properties.update.path={value:e}}function m(a,b,c,d,e,f){var g=c?{}:a,h=a.mark.def.offset,i=a.mark.def.orient,j=b.width,k=b.height;switch(t.isObject(h)&&(h=-b.scale(h.scale)(h.value)),i){case"left":s.set(g,"x",-h),s.set(g,"y",0);break;case"right":s.set(g,"x",j+h),s.set(g,"y",0);break;case"bottom":s.set(g,"x",0),s.set(g,"y",k+h);break;case"top":s.set(g,"x",0),s.set(g,"y",-h);break;default:s.set(g,"x",0),s.set(g,"y",0)}c&&c.interpolate(a,g)}function n(){return{type:"rule",interactive:!1,key:"data",properties:{enter:{stroke:{value:r.axis.tickColor},strokeWidth:{value:r.axis.tickWidth},opacity:{value:1e-6}},exit:{opacity:{value:1e-6}},update:{opacity:{value:1}}}}}function o(){return{type:"text",interactive:!0,key:"data",properties:{enter:{fill:{value:r.axis.tickLabelColor},font:{value:r.axis.tickLabelFont},fontSize:{value:r.axis.tickLabelFontSize},opacity:{value:1e-6},text:{field:"label"}},exit:{opacity:{value:1e-6}},update:{opacity:{value:1}}}}}function p(){return{type:"text",interactive:!0,properties:{enter:{font:{value:r.axis.titleFont},fontSize:{value:r.axis.titleFontSize},fontWeight:{value:r.axis.titleFontWeight},fill:{value:r.axis.titleColor},align:{value:"center"},baseline:{value:"middle"},text:{field:"data"}},update:{}}}}function q(){return{type:"path",interactive:!1,properties:{enter:{x:{value:.5},y:{value:.5},stroke:{value:r.axis.axisColor},strokeWidth:{value:r.axis.axisWidth}},update:{}}}}var r=b("../util/config"),s=b("../dataflow/tuple"),t=b("../util/index"),u=b("../parse/mark"),v={top:1,right:1,bottom:1,left:1},w={bottom:"center",top:"center",left:"right",right:"left"},x={bottom:"top",top:"bottom",left:"middle",right:"middle"};return e}),f("parse/axes",["require","exports","module","../scene/axis","../util/config","../util/index"],function(a,b,c){function d(a,b,c,d){(b||[]).forEach(function(b,g){c[g]=c[g]||f(a),e(b,g,c[g],d)})}function e(a,b,c,d){void 0!==a.scale&&c.scale(d.scale(a.scale)),c.orient(a.orient||i[a.type]),c.offset(a.offset||0),c.layer(a.layer||"front"),c.grid(a.grid||!1),c.title(a.title||null),c.titleOffset(null!=a.titleOffset?a.titleOffset:g.axis.titleOffset),c.tickValues(a.values||null),c.tickFormat(a.format||null),c.tickSubdivide(a.subdivide||0),c.tickPadding(a.tickPadding||g.axis.padding);var e=[];if(void 0!==a.tickSize)for(var f=0;3>f;++f)e.push(a.tickSize);else{var j=g.axis.tickSize;e=[j,j,j]}if(null!=a.tickSizeMajor&&(e[0]=a.tickSizeMajor),null!=a.tickSizeMinor&&(e[1]=a.tickSizeMinor),null!=a.tickSizeEnd&&(e[2]=a.tickSizeEnd),e.length&&c.tickSize.apply(c,e),null!=a.ticks){var k=h.isArray(a.ticks)?a.ticks:[a.ticks];c.ticks.apply(c,k)}else c.ticks(g.axis.ticks);var l=a.properties;l&&l.ticks?(c.majorTickProperties(l.majorTicks?h.extend({},l.ticks,l.majorTicks):l.ticks),c.minorTickProperties(l.minorTicks?h.extend({},l.ticks,l.minorTicks):l.ticks)):(c.majorTickProperties(l&&l.majorTicks||{}),c.minorTickProperties(l&&l.minorTicks||{})),c.tickLabelProperties(l&&l.labels||{}),c.titleProperties(l&&l.title||{}),c.gridLineProperties(l&&l.grid||{}),c.domainProperties(l&&l.axis||{})}var f=a("../scene/axis"),g=a("../util/config"),h=a("../util/index"),i={x:"bottom",y:"left",top:"top",bottom:"bottom",left:"left",right:"right"};return d}),f("scene/GroupBuilder",["require","exports","module","../dataflow/Node","../dataflow/Collector","./Builder","./Scale","../parse/axes","../util/index","../util/constants"],function(a,b,d){function e(){return this._children={},this._scaler=null,this._recursor=null,this._scales={},this.scale=g.bind(this),arguments.length?this.init.apply(this,arguments):this}function f(a){var b,d,e,f,g,h=this,l=this._def.marks&&this._def.marks.length>0,m=this._def.axes&&this._def.axes.length>0,n=!1;for(b=0,d=a.add.length;d>b;++b)e=a.add[b],l&&i.call(this,a,e),m&&k.call(this,a,e);for(b=a.add.length-1;b>=0;--b)for(e=a.add[b],j=this._children[e._id].length-1;j>=0;--j)c=this._children[e._id][j],c.builder.connect(),f=c.builder.pipeline(),g=c.builder._def,n=g.type!==r.GROUP,n=n&&void 0!==this._model.data(c.from),n=n&&1==f[f.length-1].listeners().length,c.inline=n,n?c.builder.evaluate(a):this._recursor.addListener(c.builder);for(b=0,d=a.mod.length;d>b;++b)e=a.mod[b],l&&h._children[e._id].forEach(function(a){a.type!=r.MARK||a.inline||void 0===h._model.data(a.from)||h._recursor.removeListener(a.builder)}),m&&(p(h._model,h._def.axes,e.axes,e),e.axes.forEach(function(a,b){a.def()}));for(b=0,d=a.rem.length;d>b;++b)e=a.rem[b],h._children[e._id].forEach(function(a){h._recursor.removeListener(a.builder),a.builder.disconnect()}),delete h._children[e._id];return a}function g(a,b){var c=this;if(2===arguments.length)return c._scales[a]=b,b;for(;null==b&&(b=c._scales[a],c=c.mark?c.mark.group:c._parent););return b}function h(a,b){q.debug(a,["building group",b._id]),b._scales=b._scales||{},b.scale=g.bind(b),b.items=b.items||[],this._children[b._id]=this._children[b._id]||[],b.axes=b.axes||[],b.axisItems=b.axisItems||[]}function i(a,b){q.debug(a,["building marks",b._id]);var c,d,f,g,h,i,j=this._def.marks;for(g=0,h=j.length;h>g;++g)c=j[g],d=c.from||{},f="vg_"+b.datum._id,b.items[g]={group:b},i=c.type===r.GROUP?new e:new n,i.init(this._model,c,b.items[g],this,b._id,f),this._children[b._id].push({builder:i,from:d.data||(d.mark?"vg_"+b._id+"_"+d.mark:f),type:r.MARK})}function k(a,b){var c=b.axes,d=b.axisItems,f=this;p(this._model,this._def.axes,c,b),c.forEach(function(a,c){var g=f._def.axes[c].scale,h=a.def(),i=null;d[c]={group:b,axisDef:h},i=h.type===r.GROUP?new e:new n,i.init(f._model,h,d[c],f).dependency(r.SCALES,g),f._children[b._id].push({builder:i,type:r.AXIS,scale:g})})}var l=a("../dataflow/Node"),m=a("../dataflow/Collector"),n=a("./Builder"),o=a("./Scale"),p=a("../parse/axes"),q=a("../util/index"),r=a("../util/constants"),s=e.prototype=new n;return s.init=function(a,b,c,d,e,g){var h=this;this._scaler=new l(a.graph),(b.scales||[]).forEach(function(b){b=h.scale(b.name,new o(a,b,h)),h._scaler.addListener(b)}),this._recursor=new l(a.graph),this._recursor.evaluate=f.bind(this);var i=(b.axes||[]).reduce(function(a,b){return a[b.scale]=1,a},{});return this._recursor.dependency(r.SCALES,q.keys(i)),this._collector=new m(a.graph),n.prototype.init.apply(this,arguments)},s.evaluate=function(a){var b=n.prototype.evaluate.apply(this,arguments),c=this;return b.add.forEach(function(a){h.call(c,b,a)}),b},s.pipeline=function(){return[this,this._scaler,this._recursor,this._collector,this._bounder]},s.disconnect=function(){var a=this;return q.keys(a._children).forEach(function(b){a._children[b].forEach(function(b){a._recursor.removeListener(b.builder),b.builder.disconnect()})}),a._children={},n.prototype.disconnect.call(this)},s.child=function(a,b){for(var c,d=this._children[b],e=0,f=d.length;f>e&&(c=d[e],c.type!=r.MARK||c.builder._def.name!=a);++e);return c.builder},e}),f("core/Model",["require","exports","module","../dataflow/Graph","../dataflow/Node","../scene/GroupBuilder","../dataflow/changeset","../util/index"],function(a,b,c){function d(){this._defs={},this._predicates={},this._scene=null,this.graph=new f,this._node=new g(this.graph),this._builder=null}function e(a){var b=this,c={};return j.isArray(a)?(a.forEach(function(a){c[a]=b._predicates[a]}),c):this._predicates[a]}var f=a("../dataflow/Graph"),g=a("../dataflow/Node"),h=a("../scene/GroupBuilder"),i=a("../dataflow/changeset"),j=a("../util/index"),k=d.prototype;return k.defs=function(a){return arguments.length?(this._defs=a,this):this._defs},k.data=function(){var a=this.graph.data.apply(this.graph,arguments);return arguments.length>1&&this._node.addListener(a.pipeline()[0]),a},k.predicate=function(a,b){return 1===arguments.length?e.call(this,a):this._predicates[a]=b},k.predicates=function(){return this._predicates},k.scene=function(a){if(!arguments.length)return this._scene;this._builder&&this._node.removeListener(this._builder.disconnect()),this._builder=new h(this,this._defs.marks,this._scene={}),this._node.addListener(this._builder.connect());var b=this._builder.pipeline();return b[b.length-1].addListener(a),this},k.addListener=function(a){this._node.addListener(a)},k.removeListener=function(a){this._node.removeListener(a)},k.fire=function(a){a||(a=i.create()),this.graph.propagate(a,this._node)},d}),f("parse/events",[],function(){function a(a,b){function c(){this.constructor=a}c.prototype=b.prototype,a.prototype=new c}function b(a,b,c,d,e,f){this.message=a,this.expected=b,this.found=c,this.offset=d,this.line=e,this.column=f,this.name="SyntaxError"}function c(a){function c(b){function c(b,c,d){var e,f;for(e=c;d>e;e++)f=a.charAt(e),"\n"===f?(b.seenCR||b.line++,b.column=1,b.seenCR=!1):"\r"===f||"\u2028"===f||"\u2029"===f?(b.line++,b.column=1,b.seenCR=!0):(b.column++,b.seenCR=!1)}return Na!==b&&(Na>b&&(Na=0,Oa={line:1,column:1,seenCR:!1}),c(Oa,Na,b),Na=b),Oa}function d(a){Pa>La||(La>Pa&&(Pa=La,Qa=[]),Qa.push(a))}function e(d,e,f){function g(a){var b=1;for(a.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0});b<a.length;)a[b-1]===a[b]?a.splice(b,1):b++}function h(a,b){function c(a){function b(a){return a.charCodeAt(0).toString(16).toUpperCase()}return a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(a){return"\\x0"+b(a)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(a){return"\\x"+b(a)}).replace(/[\u0180-\u0FFF]/g,function(a){return"\\u0"+b(a)}).replace(/[\u1080-\uFFFF]/g,function(a){return"\\u"+b(a)})}var d,e,f,g=new Array(a.length);for(f=0;f<a.length;f++)g[f]=a[f].description;return d=a.length>1?g.slice(0,-1).join(", ")+" or "+g[a.length-1]:g[0],e=b?'"'+c(b)+'"':"end of input","Expected "+d+" but "+e+" found."}var i=c(f),j=f<a.length?a.charAt(f):null;return null!==e&&g(e),new b(null!==d?d:h(e,j),e,j,f,i.line,i.column)}function f(){var a;return a=g()}function g(){var b,c,e,f,i,j;return b=La,c=h(),c!==s?(e=p(),e!==s?(44===a.charCodeAt(La)?(f=w,La++):(f=s,0===Ra&&d(x)),f!==s?(i=p(),i!==s?(j=g(),j!==s?(Ma=b,c=y(c,j),b=c):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v),b===s&&(b=La,c=h(),c!==s&&(Ma=b,c=z(c)),b=c),b}function h(){var b,c,e,f,g,j,k,l,m,n,o,q,r,t;return b=La,91===a.charCodeAt(La)?(c=A,La++):(c=s,0===Ra&&d(B)),c!==s?(e=p(),e!==s?(f=i(),f!==s?(g=p(),g!==s?(44===a.charCodeAt(La)?(j=w,La++):(j=s,0===Ra&&d(x)),j!==s?(k=p(),k!==s?(l=i(),l!==s?(m=p(),m!==s?(93===a.charCodeAt(La)?(n=C,La++):(n=s,0===Ra&&d(D)),n!==s?(o=p(),o!==s?(62===a.charCodeAt(La)?(q=E,La++):(q=s,0===Ra&&d(F)),q!==s?(r=p(),r!==s?(t=h(),t!==s?(Ma=b,c=G(f,l,t),b=c):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v)):(La=b,b=v),b===s&&(b=i()),b}function i(){var a,b,c,d;if(a=La,b=j(),b!==s){if(c=[],d=n(),d!==s)for(;d!==s;)c.push(d),d=n();else c=v;c!==s?(Ma=a,b=H(b,c),a=b):(La=a,a=v)}else La=a,a=v;return a===s&&(a=La,b=j(),b!==s&&(Ma=a,b=I(b)),a=b),a}function j(){var b,c,e,f;if(b=La,c=k(),c===s&&(c=l()),c===s&&(c=J),c!==s?(e=m(),e!==s?(Ma=b,c=K(c,e),b=c):(La=b,b=v)):(La=b,b=v),b===s){if(b=La,c=[],L.test(a.charAt(La))?(e=a.charAt(La),La++):(e=s,0===Ra&&d(M)),e!==s)for(;e!==s;)c.push(e),L.test(a.charAt(La))?(e=a.charAt(La),La++):(e=s,0===Ra&&d(M));else c=v;c!==s&&(Ma=b,c=N(c)),b=c,b===s&&(b=La,40===a.charCodeAt(La)?(c=O,La++):(c=s,0===Ra&&d(P)),c!==s?(e=g(),e!==s?(41===a.charCodeAt(La)?(f=Q,La++):(f=s,0===Ra&&d(R)),f!==s?(Ma=b,c=S(e),b=c):(La=b,b=v)):(La=b,b=v)):(La=b,b=v))}return b}function k(){var b,c,e,f;return b=La,46===a.charCodeAt(La)?(c=T,La++):(c=s,0===Ra&&d(U)),c!==s?(e=o(),e!==s?(58===a.charCodeAt(La)?(f=V,La++):(f=s,0===Ra&&d(W)),f!==s?(Ma=b,c=X(e),b=c):(La=b,b=v)):(La=b,b=v)):(La=b,b=v),b}function l(){var b,c,e,f;return b=La,35===a.charCodeAt(La)?(c=Y,La++):(c=s,0===Ra&&d(Z)),c!==s?(e=o(),e!==s?(58===a.charCodeAt(La)?(f=V,La++):(f=s,0===Ra&&d(W)),f!==s?(Ma=b,c=$(e),b=c):(La=b,b=v)):(La=b,b=v)):(La=b,b=v),b}function m(){
var b;return a.substr(La,9)===_?(b=_,La+=9):(b=s,0===Ra&&d(aa)),b===s&&(a.substr(La,7)===ba?(b=ba,La+=7):(b=s,0===Ra&&d(ca)),b===s&&(a.substr(La,5)===da?(b=da,La+=5):(b=s,0===Ra&&d(ea)),b===s&&(a.substr(La,8)===fa?(b=fa,La+=8):(b=s,0===Ra&&d(ga)),b===s&&(a.substr(La,5)===ha?(b=ha,La+=5):(b=s,0===Ra&&d(ia)),b===s&&(a.substr(La,7)===ja?(b=ja,La+=7):(b=s,0===Ra&&d(ka)),b===s&&(a.substr(La,8)===la?(b=la,La+=8):(b=s,0===Ra&&d(ma)),b===s&&(a.substr(La,5)===na?(b=na,La+=5):(b=s,0===Ra&&d(oa)),b===s&&(a.substr(La,10)===pa?(b=pa,La+=10):(b=s,0===Ra&&d(qa)),b===s&&(a.substr(La,9)===ra?(b=ra,La+=9):(b=s,0===Ra&&d(sa)),b===s&&(a.substr(La,8)===ta?(b=ta,La+=8):(b=s,0===Ra&&d(ua)),b===s&&(a.substr(La,9)===va?(b=va,La+=9):(b=s,0===Ra&&d(wa)),b===s&&(a.substr(La,10)===xa?(b=xa,La+=10):(b=s,0===Ra&&d(ya)),b===s&&(a.substr(La,10)===za?(b=za,La+=10):(b=s,0===Ra&&d(Aa)),b===s&&(a.substr(La,9)===Ba?(b=Ba,La+=9):(b=s,0===Ra&&d(Ca)),b===s&&(a.substr(La,8)===Da?(b=Da,La+=8):(b=s,0===Ra&&d(Ea))))))))))))))))),b}function n(){var b,c,e,f;return b=La,91===a.charCodeAt(La)?(c=A,La++):(c=s,0===Ra&&d(B)),c!==s?(e=o(),e!==s?(93===a.charCodeAt(La)?(f=C,La++):(f=s,0===Ra&&d(D)),f!==s?(Ma=b,c=Fa(e),b=c):(La=b,b=v)):(La=b,b=v)):(La=b,b=v),b}function o(){var b,c,e;if(b=La,c=[],Ga.test(a.charAt(La))?(e=a.charAt(La),La++):(e=s,0===Ra&&d(Ha)),e!==s)for(;e!==s;)c.push(e),Ga.test(a.charAt(La))?(e=a.charAt(La),La++):(e=s,0===Ra&&d(Ha));else c=v;return c!==s&&(Ma=b,c=Ia(c)),b=c}function p(){var b,c;for(b=[],Ja.test(a.charAt(La))?(c=a.charAt(La),La++):(c=s,0===Ra&&d(Ka));c!==s;)b.push(c),Ja.test(a.charAt(La))?(c=a.charAt(La),La++):(c=s,0===Ra&&d(Ka));return b}var q,r=arguments.length>1?arguments[1]:{},s={},t={start:f},u=f,v=s,w=",",x={type:"literal",value:",",description:'","'},y=function(a,b){return[a].concat(b)},z=function(a){return[a]},A="[",B={type:"literal",value:"[",description:'"["'},C="]",D={type:"literal",value:"]",description:'"]"'},E=">",F={type:"literal",value:">",description:'">"'},G=function(a,b,c){return{start:a,end:b,middle:c}},H=function(a,b){return a.filters=b,a},I=function(a){return a},J=null,K=function(a,b){return{event:b,target:a}},L=/^[:a-zA-z0-9_\-]/,M={type:"class",value:"[:a-zA-z0-9_\\-]",description:"[:a-zA-z0-9_\\-]"},N=function(a){return{signal:a.join("")}},O="(",P={type:"literal",value:"(",description:'"("'},Q=")",R={type:"literal",value:")",description:'")"'},S=function(a){return{stream:a}},T=".",U={type:"literal",value:".",description:'"."'},V=":",W={type:"literal",value:":",description:'":"'},X=function(a){return{type:"class",value:a}},Y="#",Z={type:"literal",value:"#",description:'"#"'},$=function(a){return{type:"id",value:a}},_="mousedown",aa={type:"literal",value:"mousedown",description:'"mousedown"'},ba="mouseup",ca={type:"literal",value:"mouseup",description:'"mouseup"'},da="click",ea={type:"literal",value:"click",description:'"click"'},fa="dblclick",ga={type:"literal",value:"dblclick",description:'"dblclick"'},ha="wheel",ia={type:"literal",value:"wheel",description:'"wheel"'},ja="keydown",ka={type:"literal",value:"keydown",description:'"keydown"'},la="keypress",ma={type:"literal",value:"keypress",description:'"keypress"'},na="keyup",oa={type:"literal",value:"keyup",description:'"keyup"'},pa="mousewheel",qa={type:"literal",value:"mousewheel",description:'"mousewheel"'},ra="mousemove",sa={type:"literal",value:"mousemove",description:'"mousemove"'},ta="mouseout",ua={type:"literal",value:"mouseout",description:'"mouseout"'},va="mouseover",wa={type:"literal",value:"mouseover",description:'"mouseover"'},xa="mouseenter",ya={type:"literal",value:"mouseenter",description:'"mouseenter"'},za="touchstart",Aa={type:"literal",value:"touchstart",description:'"touchstart"'},Ba="touchmove",Ca={type:"literal",value:"touchmove",description:'"touchmove"'},Da="touchend",Ea={type:"literal",value:"touchend",description:'"touchend"'},Fa=function(a){return a},Ga=/^['"a-zA-Z0-9_.><=! \t\-]/,Ha={type:"class",value:"['\"a-zA-Z0-9_.><=! \\t\\-]",description:"['\"a-zA-Z0-9_.><=! \\t\\-]"},Ia=function(a){return a.join("")},Ja=/^[ \t\r\n]/,Ka={type:"class",value:"[ \\t\\r\\n]",description:"[ \\t\\r\\n]"},La=0,Ma=0,Na=0,Oa={line:1,column:1,seenCR:!1},Pa=0,Qa=[],Ra=0;if("startRule"in r){if(!(r.startRule in t))throw new Error("Can't start parsing from rule \""+r.startRule+'".');u=t[r.startRule]}if(q=u(),q!==s&&La===a.length)return q;throw q!==s&&La<a.length&&d({type:"end",description:"end of input"}),e(null,Qa,Pa)}return a(b,Error),{SyntaxError:b,parse:c}}),f("parse/streams",["require","exports","module","d3","../dataflow/Node","../dataflow/changeset","./events","./expr","../util/index","../util/constants"],function(a,b,c){var d=a("d3"),e=a("../dataflow/Node"),f=a("../dataflow/changeset"),g=a("./events"),h=a("./expr"),i=a("../util/index"),j=a("../util/constants"),k="start",l="middle",m="end";return function(a){function b(a,b,c){c&&c.scale||(c=c&&c.mark?c.mark.group:q.scene().items[0]);var d=c.scale(a.scale.signal||a.scale);return d?a.invert?d.invert(b):d(b):b}function c(a,c,d,f){var g=new e(r),i=f.item?r.signal(f.item.signal):null;g.evaluate=function(e){if(!e.signals[c.signal])return r.doNotPropagate;var g=h.eval(r,d.fn,null,null,null,null,d.signals);return f.scale&&(g=b(f,g,i?i.value():null)),a.value(g),e.signals[a.name()]=1,e.reflow=!0,e},g.dependency(j.SIGNALS,c.signal),g.addListener(a),r.signal(c.signal).addListener(g)}function n(a,b,c,d){var f=b.filters||[],g=b.target;g&&f.push("i."+g.type+"=="+i.str(g.value)),t[b.event]=t[b.event]||[],t[b.event].push({signal:a,exp:c,filters:f.map(function(a){return h(r,a)}),spec:d}),u[b.event]=u[b.event]||new e(r),u[b.event].addListener(a)}function o(a,b,d,f){var g=a.name(),i=h(r,"true"),j={};j[k]=r.signal(g+k,!1),j[l]=r.signal(g+l,!1),j[m]=r.signal(g+m,!1);var o=new e(r);o.evaluate=function(b){return j[k].value()===!0&&j[m].value()===!1?b.signals[g+k]?r.doNotPropagate:(a.value(j[l].value()),b.signals[g]=1,b):(j[m].value()===!0&&(j[k].value(!1),j[m].value(!1)),r.doNotPropagate)},o.addListener(a),[k,l,m].forEach(function(a){var e=a==l?d:i,g=a==l?f:{};b[a].event?n(j[a],b[a],e,g):b[a].signal?c(j[a],b[a],e,g):b[a].stream&&p(j[a],b[a].stream,e,g),j[a].addListener(o)})}function p(a,b,d,e){b.forEach(function(b){b.event?n(a,b,d,e):b.signal?c(a,b,d,e):b.start?o(a,b,d,e):b.stream&&p(a,b.stream,d,e)})}var q=a.model(),r=q.graph,s=q.defs().signals,t={},u={};(s||[]).forEach(function(a){var b=r.signal(a.name);a.expr||(a.streams||[]).forEach(function(a){var c=g.parse(a.type),d=h(r,a.expr);p(b,c,d,a)})}),i.keys(t).forEach(function(c){var e=t[c],g=u[c];a.on(c,function(c,i){var j,k,l,m,n,o=f.create(null,!0),p=a.padding(),q=!1;c.preventDefault(),m=d.mouse((d.event=c,a._el)),i=i||{},n=i.datum||{};var s={x:m[0]-p.left,y:m[1]-p.top};for(l=0;l<e.length;l++)k=e[l],q=k.filters.some(function(a){return!h.eval(r,a.fn,n,c,i,s,a.signals)}),q||(j=h.eval(r,k.exp.fn,n,c,i,s,k.exp.signals),k.spec.scale&&(j=b(k.spec,j,i)),k.signal.value(j),o.signals[k.signal.name()]=1);r.propagate(o,g)})})}}),f("render/canvas/marks",["require","exports","module","../../core/Bounds","../../util/bounds","../../util/index","../../util/config","./path"],function(a,b,c){function d(a,b){var c=b.x||0,d=b.y||0,e=b.innerRadius||0,f=b.outerRadius||0,g=(b.startAngle||0)-Math.PI/2,h=(b.endAngle||0)-Math.PI/2;a.beginPath(),0===e?a.moveTo(c,d):a.arc(c,d,e,g,h,0),a.arc(c,d,f,h,g,1),a.closePath()}function e(a,b){var c=b[0],d=c.mark,e=d.pathCache||(d.pathCache=G(F.area(b)));H(a,e)}function f(a,b){var c=b[0],d=c.mark,e=d.pathCache||(d.pathCache=G(F.line(b)));H(a,e)}function g(a,b){if(null!=b.path){var c=b.pathCache||(b.pathCache=G(b.path));return H(a,c,b.x,b.y)}}function h(a,b){a.beginPath();var c,d,e,f,g=null!=b.size?b.size:100,h=b.x,i=b.y;if(null==b.shape||"circle"===b.shape)return c=Math.sqrt(g/Math.PI),a.arc(h,i,c,0,2*Math.PI,0),void a.closePath();switch(b.shape){case"cross":c=Math.sqrt(g/5)/2,d=3*c,a.moveTo(h-d,i-c),a.lineTo(h-c,i-c),a.lineTo(h-c,i-d),a.lineTo(h+c,i-d),a.lineTo(h+c,i-c),a.lineTo(h+d,i-c),a.lineTo(h+d,i+c),a.lineTo(h+c,i+c),a.lineTo(h+c,i+d),a.lineTo(h-c,i+d),a.lineTo(h-c,i+c),a.lineTo(h-d,i+c);break;case"diamond":f=Math.sqrt(g/(2*J)),e=f*J,a.moveTo(h,i-f),a.lineTo(h+e,i),a.lineTo(h,i+f),a.lineTo(h-e,i);break;case"square":d=Math.sqrt(g),c=d/2,a.rect(h-c,i-c,d,d);break;case"triangle-down":e=Math.sqrt(g/I),f=e*I/2,a.moveTo(h,i+f),a.lineTo(h+e,i-f),a.lineTo(h-e,i-f);break;case"triangle-up":e=Math.sqrt(g/I),f=e*I/2,a.moveTo(h,i-f),a.lineTo(h+e,i+f),a.lineTo(h-e,i+f)}a.closePath()}function i(a,b){var c=b[0],d=c.strokeWidth,e=c.strokeCap;a.lineWidth=null!=d?d:E.render.lineWidth,a.lineCap=null!=e?e:E.render.lineCap,f(a,b)}function j(a,b){var c=b.x||0,d=b.y||0,e=null!=b.x2?b.x2:c,f=null!=b.y2?b.y2:d,g=b.strokeWidth,h=b.strokeCap;a.lineWidth=null!=g?g:E.render.lineWidth,a.lineCap=null!=h?h:E.render.lineCap,a.beginPath(),a.moveTo(c,d),a.lineTo(e,f)}function k(a,b,c,d){var e,f,g,h=c.fill,i=c.stroke;a(b,d),e=null==c.opacity?1:c.opacity,0!=e&&(h||i)&&(h&&(b.globalAlpha=e*(null==c.fillOpacity?1:c.fillOpacity),b.fillStyle=t(b,c,h),b.fill()),i&&(g=null!=(g=c.strokeWidth)?g:E.render.lineWidth,g>0&&(b.globalAlpha=e*(null==c.strokeOpacity?1:c.strokeOpacity),b.strokeStyle=t(b,c,i),b.lineWidth=g,b.lineCap=null!=(f=c.strokeCap)?f:E.render.lineCap,b.vgLineDash(c.strokeDash||null),b.vgLineDashOffset(c.strokeDashOffset||0),b.stroke())))}function l(a,b,c,d){var e,f,g;for(e=0,f=c.items.length;f>e;++e)g=c.items[e],(!d||d.intersects(g.bounds))&&k(a,b,g,g)}function m(a,b,c){if(b.items.length)for(var d,e,f,g,h,i,j,k,l,m,n=b.items,o=0,p=n.length;p>o;++o)d=n[o],(!c||c.intersects(d.bounds))&&(j=d.x||0,k=d.y||0,l=d.width||0,m=d.height||0,g=null==d.opacity?1:d.opacity,0!=g&&((e=d.fill)&&(a.globalAlpha=g*(null==d.fillOpacity?1:d.fillOpacity),a.fillStyle=t(a,d,e),a.fillRect(j,k,l,m)),(f=d.stroke)&&(i=null!=(i=d.strokeWidth)?i:E.render.lineWidth,i>0&&(a.globalAlpha=g*(null==d.strokeOpacity?1:d.strokeOpacity),a.strokeStyle=t(a,d,f),a.lineWidth=i,a.lineCap=null!=(h=d.strokeCap)?h:E.render.lineCap,a.vgLineDash(d.strokeDash||null),a.vgLineDashOffset(d.strokeDashOffset||0),a.strokeRect(j,k,l,m)))))}function n(a,b,c){if(b.items.length)for(var d,e,f,g,h,i,j,k,l,m=b.items,n=0,o=m.length;o>n;++n)d=m[n],(!c||c.intersects(d.bounds))&&(i=d.x||0,j=d.y||0,k=null!=d.x2?d.x2:i,l=null!=d.y2?d.y2:j,f=null==d.opacity?1:d.opacity,0!=f&&(e=d.stroke)&&(h=null!=(h=d.strokeWidth)?h:E.render.lineWidth,h>0&&(a.globalAlpha=f*(null==d.strokeOpacity?1:d.strokeOpacity),a.strokeStyle=t(a,d,e),a.lineWidth=h,a.lineCap=null!=(g=d.strokeCap)?g:E.render.lineCap,a.vgLineDash(d.strokeDash||null),a.vgLineDashOffset(d.strokeDashOffset||0),a.beginPath(),a.moveTo(i,j),a.lineTo(k,l),a.stroke())))}function o(a,b,c){if(b.items.length)for(var d,e=this,f=b.items,g=0,h=f.length;h>g;++g)if(d=f[g],!c||c.intersects(d.bounds)){d.image&&d.image.url===d.url||(d.image=e.loadImage(d.url),d.image.url=d.url);var i,j,k,l,m;k=d.width||d.image&&d.image.width||0,l=d.height||d.image&&d.image.height||0,i=(d.x||0)-("center"===d.align?k/2:"right"===d.align?k:0),j=(d.y||0)-("middle"===d.baseline?l/2:"bottom"===d.baseline?l:0),d.image.loaded&&(a.globalAlpha=null!=(m=d.opacity)?m:1,a.drawImage(d.image,i,j,k,l))}}function p(a,b,c){if(b.items.length)for(var d,e,f,g,h,i,j,k,l,m=b.items,n=0,o=m.length;o>n;++n)d=m[n],(!c||c.intersects(d.bounds))&&(a.font=D.fontString(d),a.textAlign=d.align||"left",a.textBaseline=d.baseline||"alphabetic",g=null==d.opacity?1:d.opacity,0!=g&&(i=d.x||0,j=d.y||0,(k=d.radius)&&(l=(d.theta||0)-Math.PI/2,i+=k*Math.cos(l),j+=k*Math.sin(l)),d.angle?(a.save(),a.translate(i,j),a.rotate(d.angle*Math.PI/180),i=d.dx||0,j=d.dy||0):(i+=d.dx||0,j+=d.dy||0),(e=d.fill)&&(a.globalAlpha=g*(null==d.fillOpacity?1:d.fillOpacity),a.fillStyle=t(a,d,e),a.fillText(d.text,i,j)),(f=d.stroke)&&(h=null!=(h=d.strokeWidth)?h:1,h>0&&(a.globalAlpha=g*(null==d.strokeOpacity?1:d.strokeOpacity),a.strokeStyle=t(d,f),a.lineWidth=h,a.strokeText(d.text,i,j))),d.angle&&a.restore()))}function q(a){return function(b,c,d){l(a,b,c,d)}}function r(a){return function(b,c,d){c.items.length&&(!d||d.intersects(c.items[0].bounds))&&k(a,b,c.items[0],c.items)}}function s(a,b,c){if(b.items.length){var d,e,f,g,h,i,j,k,l,n=b.items,o=this;for(m(a,b,c),i=0,j=n.length;j>i;++i){for(d=n[i],e=d.axisItems||[],f=d.legendItems||[],g=d.x||0,h=d.y||0,a.save(),a.translate(g,h),d.clip&&(a.beginPath(),a.rect(0,0,d.width||0,d.height||0),a.clip()),c&&c.translate(-g,-h),k=0,l=e.length;l>k;++k)"back"===e[k].def.layer&&o.draw(a,e[k],c);for(k=0,l=d.items.length;l>k;++k)o.draw(a,d.items[k],c);for(k=0,l=e.length;l>k;++k)"back"!==e[k].def.layer&&o.draw(a,e[k],c);for(k=0,l=f.length;l>k;++k)o.draw(a,f[k],c);c&&c.translate(g,h),a.restore()}}}function t(a,b,c){return c.id?u(a,c,b.bounds):c}function u(a,b,c){var d,e,f=c.width(),g=c.height(),h=c.x1+b.x1*f,i=c.y1+b.y1*g,j=c.x1+b.x2*f,k=c.y1+b.y2*g,l=a.createLinearGradient(h,i,j,k),m=b.stops;for(d=0,e=m.length;e>d;++d)l.addColorStop(m[d].offset,m[d].color);return l}function v(a,b,c,d,e,f){if(0===b.items.length||b.bounds&&!b.bounds.contains(e,f))return!1;var g,h,i,j,k,l,m,n=b.items,o=this;for(l=n.length;--l>=0;){for(h=n[l],j=h.x||0,k=h.y||0,a.save(),a.translate(j,k),m=h.items.length;--m>=0;)if(g=h.items[m],g.interactive!==!1&&(i=o.pick(g,c,d,e-j,f-k)))return a.restore(),i;a.restore()}return b.interactive?w(L.group,a,b,c,d,e,f):!1}function w(a,b,c,d,e,f,g){if(!c.items.length)return!1;var h,i,j;for(1!==b._ratio&&(d*=b._ratio,e*=b._ratio),j=c.items.length;--j>=0;)if(h=c.items[j],i=h.bounds,(!i||i.contains(f,g))&&i&&a(b,h,d,e,f,g))return h;return!1}function x(a,b,c,d,e,f){if(!b.items.length)return!1;var g,h=b.items;return g=h[0].bounds,g&&!g.contains(e,f)?!1:(1!==a._ratio&&(c*=a._ratio,d*=a._ratio),L.area(a,h,c,d)?h[0]:!1)}function y(a,b,c,d,e,f){if(!b.items.length)return!1;var g,h=b.items;return g=h[0].bounds,g&&!g.contains(e,f)?!1:(1!==a._ratio&&(c*=a._ratio,d*=a._ratio),L.line(a,h,c,d)?h[0]:!1)}function z(a){return function(b,c,d,e,f,g){return w(a,b,c,d,e,f,g)}}function A(a,b,c,d,e,f){if(!b.fontSize)return!1;if(!b.angle)return!0;var g=C.text(b,K,!0),h=-b.angle*Math.PI/180,i=Math.cos(h),j=Math.sin(h),c=b.x,d=b.y,k=i*e-j*f+(c-c*i+d*j),l=j*e+i*f+(d-c*j-d*i);return g.contains(k,l)}var B=a("../../core/Bounds"),C=a("../../util/bounds"),D=a("../../util/index"),E=a("../../util/config"),F=a("./path"),G=F.parse,H=F.render,I=(Math.PI/2,Math.sqrt(3)),J=Math.tan(30*Math.PI/180),K=new B,L={text:A,rect:function(a,b,c,d){return!0},image:function(a,b,c,d){return!0},group:function(a,b,c,d){return b.fill||b.stroke},rule:function(a,b,c,d){return a.isPointInStroke?(j(a,b),a.isPointInStroke(c,d)):!1},line:function(a,b,c,d){return a.isPointInStroke?(i(a,b),a.isPointInStroke(c,d)):!1},arc:function(a,b,c,e){return d(a,b),a.isPointInPath(c,e)},area:function(a,b,c,d){return e(a,b),a.isPointInPath(c,d)},path:function(a,b,c,d){return g(a,b),a.isPointInPath(c,d)},symbol:function(a,b,c,d){return h(a,b),a.isPointInPath(c,d)}};return{draw:{group:s,area:r(e),line:r(f),arc:q(d),path:q(g),symbol:q(h),rect:m,rule:n,text:p,image:o,drawOne:r,drawAll:q},pick:{group:v,area:x,line:y,arc:z(L.arc),path:z(L.path),symbol:z(L.symbol),rect:z(L.rect),rule:z(L.rule),text:z(L.text),image:z(L.image),pickAll:w}}}),f("render/canvas/Handler",["require","exports","module","d3","../../util/index","./marks"],function(a,b,c){function d(a){var b=a.indexOf(".");return 0>b?a:a.slice(0,b)}var e=a("d3"),f=a("../../util/index"),g=a("./marks"),h=function(a,b){this._active=null,this._handlers={},a&&this.initialize(a),b&&this.model(b)},i=h.prototype;i.initialize=function(a,b,c){this._el=e.select(a).node(),this._canvas=e.select(a).select("canvas.marks").node(),this._padding=b,this._obj=c||null;var d=this._canvas,f=this;return j.forEach(function(a){d.addEventListener(a,function(b){i[a].call(f,b)})}),this},i.padding=function(a){return this._padding=a,this},i.model=function(a){return arguments.length?(this._model=a,this):this._model},i.handlers=function(){var a=this._handlers;return f.keys(a).reduce(function(b,c){return a[c].reduce(function(a,b){return a.push(b),a},b)},[])};var j=["mousedown","mouseup","click","dblclick","wheel","keydown","keypress","keyup","mousewheel","touchstart"];return j.forEach(function(a){i[a]=function(b){this.fire(a,b)}}),j.push("mousemove"),j.push("mouseout"),j.push("touchmove"),j.push("touchend"),i.touchmove=i.mousemove=function(a){var b=this._padding,c=a.target.getBoundingClientRect(),d=a.clientX-c.left,e=a.clientY-c.top,f=this._active,g=this.pick(this._model.scene(),d,e,d-b.left,e-b.top);return g===f?(this.fire("mousemove",a),void("touchmove"==a.type&&this.fire("touchmove",a))):(f&&(this.fire("mouseout",a),"touchend"==a.type&&this.fire("touchend",a)),this._active=g,void(g&&(this.fire("mouseover",a),"touchstart"==a.type&&this.fire("touchstart",a))))},i.touchend=i.mouseout=function(a){this._active&&(this.fire("mouseout",a),this.fire("touchend",a)),this._active=null},i.DOMMouseScroll=function(a){this.fire("mousewheel",a)},i.fire=function(a,b){var c=this._active,d=this._handlers[a];if(d)for(var e=0,f=d.length;f>e;++e)d[e].handler.call(this._obj,b,c)},i.on=function(a,b){var c=d(a),e=this._handlers;return e=e[c]||(e[c]=[]),e.push({type:a,handler:b}),this},i.off=function(a,b){var c=d(a),e=this._handlers[c];if(e){for(var f=e.length;--f>=0;)e[f].type===a&&(b&&e[f].handler!==b||e.splice(f,1));return this}},i.context=function(){return this._canvas.getContext("2d")},i.pick=function(a,b,c,d,e){var f=this.context(),h=a.marktype,i=g.pick[h];return i.call(this,f,a,b,c,d,e)},h}),f("render/canvas/Renderer",["require","exports","module","d3","../../core/Bounds","../../util/load","../../util/config","./marks"],function(a,b,c){function d(a,b){var c=window.devicePixelRatio||1,d=b.webkitBackingStorePixelRatio||b.mozBackingStorePixelRatio||b.msBackingStorePixelRatio||b.oBackingStorePixelRatio||b.backingStorePixelRatio||1,e=c/d;if(c!==d){var f=a.width,g=a.height;a.setAttribute("width",f*e),a.setAttribute("height",g*e),a.style.width=f+"px",a.style.height=g+"px"}return e}function e(a){if(!a.vgLineDash){var b=[];a.setLineDash?(a.vgLineDash=function(a){this.setLineDash(a||b)},a.vgLineDashOffset=function(a){this.lineDashOffset=a}):void 0!==a.webkitLineDash?(a.vgLineDash=function(a){this.webkitLineDash=a||b},a.vgLineDashOffset=function(a){this.webkitLineDashOffset=a}):void 0!==a.mozDash?(a.vgLineDash=function(a){this.mozDash=a},a.vgLineDashOffset=function(a){}):(a.vgLineDash=function(a){},a.vgLineDashOffset=function(a){})}}function f(a,b){for(var c=new j(b);null!=(a=a.mark.group);)c.translate(a.x||0,a.y||0);return c}function g(a){return a?util.array(a).reduce(function(a,b){return a.union(f(b,b.bounds)).union(f(b,b["bounds:prev"]))},new j):null}function h(a,b){var c=null;return b&&(c=new j(b).round(),a.beginPath(),a.rect(c.x1,c.y1,c.width(),c.height()),a.clip()),c}var i=a("d3"),j=a("../../core/Bounds"),k=(a("../../util/load"),a("../../util/config")),l=a("./marks"),m=function(){this._ctx=null,this._el=null,this._imgload=0},n=m.prototype;return n.initialize=function(a,b,c,d){if(this._el=a,!a)return this;var e=i.select(a).selectAll("canvas.marks").data([1]);return e.enter().append("canvas").attr("class","marks"),e.exit().remove(),this.resize(b,c,d)},n.resize=function(a,b,c){if(this._width=a,this._height=b,this._padding=c,this._el){var f=i.select(this._el).select("canvas.marks");f.attr("width",a+c.left+c.right).attr("height",b+c.top+c.bottom);var g;this._ctx=f.node().getContext("2d"),this._ctx._ratio=g=d(f.node(),this._ctx)||1,this._ctx.setTransform(g,0,0,g,g*c.left,g*c.top)}return e(this._ctx),this},n.context=function(a){return a?(this._ctx=a,this):this._ctx},n.element=function(){return this._el},n.pendingImages=function(){return this._imgload},n.render=function(a,b){var c,d=this._ctx,e=this._padding,f=this._width+e.left+e.right,i=this._height+e.top+e.bottom,j=null;this._scene=a,d.save(),j=h(d,g(b)),d.clearRect(-e.left,-e.top,f,i),this.draw(d,a,j),b&&(d.restore(),d.save(),c=h(d,g(b)),j.encloses(c)||(d.clearRect(-e.left,-e.top,f,i),this.draw(d,a,c))),d.restore(),this._scene=null},n.draw=function(a,b,c){var d=b.marktype,e=l.draw[d];e.call(this,a,b,c)},n.renderAsync=function(a){var b=this;b._async_id&&clearTimeout(b._async_id),b._async_id=setTimeout(function(){b.render(a),delete b._async_id},50)},n.loadImage=function(a){var b,c=this,d=c._scene,e=null;return c._imgload+=1,k.isNode||(e=new Image,b=k.baseURL+a,e.onload=function(){util.log("LOAD IMAGE: "+b),e.loaded=!0,c._imgload-=1,c.renderAsync(d)},e.src=b),e},m}),f("render/canvas/index",["require","exports","module","./Handler","./Renderer"],function(a,b,c){return{Handler:a("./Handler"),Renderer:a("./Renderer")}}),f("render/svg/Handler",["require","exports","module","../../util/index"],function(b,c,d){function e(a){var b=this;return function(c){var d=c.target,e=d.__data__;e&&(e=e.mark?e:e[0]),a.call(b._obj,c,e)}}function f(a){var b=a.indexOf(".");return 0>b?a:a.slice(0,b)}var g=b("../../util/index"),h=function(a,b){this._active=null,this._handlers={},a&&this.initialize(a),b&&this.model(b)},i=h.prototype;return i.initialize=function(b,c,d){return this._el=a.select(b).node(),this._svg=a.select(b).select("svg.marks").node(),this._padding=c,this._obj=d||null,this},i.padding=function(a){return this._padding=a,this},i.model=function(a){return arguments.length?(this._model=a,this):this._model},i.handlers=function(){var a=this._handlers;return g.keys(a).reduce(function(b,c){return a[c].reduce(function(a,b){return a.push(b),a},b)},[])},i.on=function(b,c){var d=f(b),g=this._handlers,h=a.select(this._svg).node(),i={type:b,handler:c,svg:e.call(this,c)};return g=g[d]||(g[d]=[]),g.push(i),h.addEventListener(d,i.svg),this},i.off=function(b,c){var d=f(b),e=this._handlers[d],g=a.select(this._svg).node();if(e){for(var h=e.length;--h>=0;)e[h].type===b&&(c&&e[h].handler!==c||(g.removeEventListener(d,e[h].svg),e.splice(h,1)));return this}},h}),f("render/svg/marks",["require","exports","module","d3","../../util/index","../../util/config"],function(a,b,c){function d(a){return a.x||0}function e(a){return a.y||0}function f(a){return a.y+a.height||0}function g(a){return null==a.size?100:a.size}function h(a){return a.shape||"circle"}function i(a){var b,c,d,e,f,g=a.mark?a:a.length?a[0]:null;if(null!==g)for(b=0,c=K.length;c>b;++b)d=K[b],e=J[d],f=g[d],null==f?"fill"===e?this.style.setProperty(e,"none",null):this.style.removeProperty(e):(f.id&&(L.current._defs.gradient[f.id]=f,f="url(#"+f.id+")"),this.style.setProperty(e,f+"",null))}function j(a){var b=a.x||0,c=a.y||0;this.setAttribute("transform","translate("+b+","+c+")"),this.setAttribute("d",C(a))}function k(a){if(a.length){var b=a[0];D.interpolate(b.interpolate||"linear").tension(null==b.tension?.7:b.tension),this.setAttribute("d",D(a))}}function l(a){if(a.length){var b=a[0];E.interpolate(b.interpolate||"linear").tension(null==b.tension?.7:b.tension),this.setAttribute("d",E(a))}}function m(a){var b=a.x||0,c=a.y||0;this.setAttribute("transform","translate("+b+","+c+")"),null!=a.path&&this.setAttribute("d",a.path)}function n(a){this.setAttribute("x",a.x||0),this.setAttribute("y",a.y||0),this.setAttribute("width",a.width||0),this.setAttribute("height",a.height||0)}function o(a){var b=a.x||0,c=a.y||0;this.setAttribute("x1",b),this.setAttribute("y1",c),this.setAttribute("x2",null!=a.x2?a.x2:b),this.setAttribute("y2",null!=a.y2?a.y2:c)}function p(a){var b=a.x||0,c=a.y||0;this.setAttribute("transform","translate("+b+","+c+")"),this.setAttribute("d",F(a))}function q(a){var b=a.width||a.image&&a.image.width||0,c=a.height||a.image&&a.image.height||0,d=a.x-("center"===a.align?b/2:"right"===a.align?b:0),e=a.y-("middle"===a.baseline?c/2:"bottom"===a.baseline?c:0),f=B.baseURL+a.url;this.setAttributeNS("http://www.w3.org/1999/xlink","href",f),this.setAttribute("x",d),this.setAttribute("y",e),this.setAttribute("width",b),this.setAttribute("height",c)}function r(a){return(a.fontStyle?a.fontStyle+" ":"")+(a.fontVariant?a.fontVariant+" ":"")+(a.fontWeight?a.fontWeight+" ":"")+(null!=a.fontSize?a.fontSize:B.render.fontSize)+"px "+(a.font||B.render.font)}function s(a){var b=a.x||0,c=a.y||0,d=a.dx||0,e=a.dy||0,f=a.angle||0,g=a.radius||0,h=I[a.align||"left"],i="top"===a.baseline?".9em":"middle"===a.baseline?".35em":0;if(g){var j=(a.theta||0)-Math.PI/2;b+=g*Math.cos(j),c+=g*Math.sin(j)}this.setAttribute("x",b+d),this.setAttribute("y",c+e),this.setAttribute("text-anchor",h),f?this.setAttribute("transform","rotate("+f+" "+b+","+c+")"):this.removeAttribute("transform"),i?this.setAttribute("dy",i):this.removeAttribute("dy"),this.textContent=a.text,this.style.setProperty("font",r(a),null)}function t(a){var b=a.x||0,c=a.y||0;if(this.setAttribute("transform","translate("+b+","+c+")"),a.clip){var d={width:a.width||0,height:a.height||0},e=a.clip_id||(a.clip_id="clip"+H++);L.current._defs.clipping[e]=d,this.setAttribute("clip-path","url(#"+e+")")}}function u(a){var b=a.width||0,c=a.height||0;this.setAttribute("width",b),this.setAttribute("height",c)}function v(a){var b="type-"+a.type;return a.name&&(b+=" "+a.name),b}function w(a,b,c){return function(d,e,f){x(d,e,f,"mark_",a,b,c)}}function x(a,b,c,d,e,f,g){var h=g?[b.items]:b.items,j=b.interactive===!1?"none":null,k=a.node().childNodes,l="g"!==e,m=(m=k[c+1])?z.select(m):a.append("g").attr("id","g"+ ++G).attr("class",v(b.def)),n=m.attr("id"),o="#"+n+" > "+e,p=m.selectAll(o).data(h),q=p.enter().append(e);return l?(m.style("pointer-events",j),q.each(function(a){a.mark?a._svg=this:a.length&&(a[0]._svg=this)})):q.append("rect").attr("class","background").style("pointer-events",j),p.exit().remove(),p.each(f),l?p.each(i):m.selectAll(o+" > rect.background").each(u).each(i),m}function y(a,b,c,d){var e,f,g,h=x(a,b,c,d||"group_","g",t),i=h.node().childNodes,j=i.length;for(e=0;j>e;++e){var k=i[e].__data__.items,l=i[e].__data__.legendItems||[],m=i[e].__data__.axisItems||[],n=z.select(i[e]),o=0;for(f=0,g=m.length;g>f;++f)"back"===m[f].def.layer&&y.call(this,n,m[f],o++,"axis_");for(f=0,g=k.length;g>f;++f)this.draw(n,k[f],o++);for(f=0,g=m.length;g>f;++f)"back"!==m[f].def.layer&&y.call(this,n,m[f],o++,"axis_");for(f=0,g=l.length;g>f;++f)y.call(this,n,l[f],o++,"legend_")}}var z=a("d3"),A=a("../../util/index"),B=a("../../util/config"),C=z.svg.arc(),D=z.svg.area().x(d).y1(e).y0(f),E=z.svg.line().x(d).y(e),F=z.svg.symbol().type(h).size(g),G=0,H=0,I={left:"start",center:"middle",right:"end"},J={fill:"fill",fillOpacity:"fill-opacity",stroke:"stroke",strokeWidth:"stroke-width",strokeOpacity:"stroke-opacity",strokeCap:"stroke-linecap",strokeDash:"stroke-dasharray",strokeDashOffset:"stroke-dashoffset",opacity:"opacity"},K=A.keys(J),L={update:{group:n,area:k,line:l,arc:j,path:m,symbol:p,rect:n,rule:o,text:s,image:q},nested:{area:!0,line:!0},style:i,draw:{group:y,area:w("path",k,!0),line:w("path",l,!0),arc:w("path",j),path:w("path",m),symbol:w("path",p),rect:w("rect",n),rule:w("line",o),text:w("text",s),image:w("image",q),draw:w},current:null};return L}),f("render/svg/Renderer",["require","exports","module","../../util/index","./marks"],function(b,c,d){var e=b("../../util/index"),f=b("./marks"),g=function(){this._svg=null,this._ctx=null,this._el=null,this._defs={gradient:{},clipping:{}}},h=g.prototype;return h.initialize=function(b,c,d,e){return this._el=b,a.select(b).select("svg.marks").remove(),this._svg=a.select(b).append("svg").attr("class","marks"),this._ctx=this._svg.append("g"),this.resize(c,d,e)},h.resize=function(a,b,c){return this._width=a,this._height=b,this._padding=c,this._svg.attr("width",a+c.left+c.right).attr("height",b+c.top+c.bottom),this._ctx.attr("transform","translate("+c.left+","+c.top+")"),this},h.context=function(){return this._ctx},h.element=function(){return this._el},h.updateDefs=function(){var b,c,d=this._svg,f=this._defs,g=e.keys(f.gradient),h=e.keys(f.clipping),i=d.select("defs");return 0===g.length&&0==h.length?void i.remove():(i.empty()&&(i=d.insert("defs",":first-child")),b=i.selectAll("linearGradient").data(g,e.identity),b.enter().append("linearGradient").attr("id",e.identity),b.exit().remove(),b.each(function(b){var c=f.gradient[b],d=a.select(this);d.attr({x1:c.x1,x2:c.x2,y1:c.y1,y2:c.y2}),stop=d.selectAll("stop").data(c.stops),stop.enter().append("stop"),stop.exit().remove(),stop.attr("offset",function(a){return a.offset}).attr("stop-color",function(a){return a.color})}),c=i.selectAll("clipPath").data(h,e.identity),c.enter().append("clipPath").attr("id",e.identity),c.exit().remove(),void c.each(function(b){var c=f.clipping[b],d=a.select(this).selectAll("rect").data([1]);d.enter().append("rect"),d.attr("x",0).attr("y",0).attr("width",c.width).attr("height",c.height)}))},h.render=function(a,b){f.current=this,b?this.renderItems(e.array(b)):this.draw(this._ctx,a,-1),this.updateDefs(),delete f.current},h.renderItems=function(a){var b,c,d,e,g;for(e=0,g=a.length;g>e;++e)b=a[e],c=b._svg,d=b.mark.marktype,b=f.nested[d]?b.mark.items:b,f.update[d].call(c,b),f.style.call(c,b)},h.draw=function(a,b,c){var d=b.marktype,e=f.draw[d];e.call(this,a,b,c)},g}),f("render/svg/index",["require","exports","module","./Handler","./Renderer"],function(a,b,c){return{Handler:a("./Handler"),Renderer:a("./Renderer")}}),f("scene/Transition",["require","exports","module","../dataflow/tuple","../util/bounds","../util/constants"],function(b,c,d){function e(b,c){this.duration=b||500,this.ease=c&&a.ease(c)||a.ease("cubic-in-out"),this.updates={next:null}}function f(a){for(var b,c,d,e,f,g,i=this.updates,j=i,k=j.next,l=this.duration,m=!0;null!=k;j=k,k=j.next)if(b=k.item,c=b.delay||0,d=(a-c)/l,0>d)m=!1;else{for(d>1&&(d=1),e=k.ease(d),f=0,g=k.length;g>f;++f)b[k[f].property]=k[f](e);b.touch(),h.item(b),1===d?(k.remove&&b.remove(),j.next=k.next,k=j):m=!1}return this.callback(),m}var g=b("../dataflow/tuple"),h=b("../util/bounds"),i=b("../util/constants"),j=e.prototype,k={text:1,url:1};return j.interpolate=function(b,c,d){var e,f,h,j,l=null;for(e in c)f=b[e],h=c[e],f!==h&&(k[e]||void 0===f?g.set(b,e,h):"number"!=typeof f||isFinite(f)?(j=a.interpolate(f,h),j.property=e,(l||(l=[])).push(j)):g.set(b,e,h));return null===l&&b.status===i.EXIT&&(l=[]),null!=l&&(l.item=b,l.ease=b.mark.ease||this.ease,l.next=this.updates.next,this.updates.next=l),this},j.start=function(b){for(var c=this,d=c.updates,e=d.next;null!=e;d=e,e=d.next)e.item.status===i.EXIT&&(e.remove=!0);c.callback=b,a.timer(function(a){return f.call(c,a)})},e}),f("core/View",["require","exports","module","d3","../dataflow/Node","../parse/streams","../render/canvas/index","../render/svg/index","../scene/Transition","../util/config","../util/index","../dataflow/changeset"],function(a,b,c){var d=a("d3"),e=a("../dataflow/Node"),f=a("../parse/streams"),g=a("../render/canvas/index"),h=a("../render/svg/index"),i=a("../scene/Transition"),j=a("../util/config"),k=a("../util/index"),l=a("../dataflow/changeset"),m=function(a,b,c,d){this._el=null,this._model=null,this._width=this.__width=b||500,this._height=this.__height=c||300,this._autopad=1,this._padding={top:0,left:0,bottom:0,right:0},this._viewport=null,this._renderer=null,this._handler=null,this._io=g,a&&this.initialize(a)},n=m.prototype;return n.model=function(a){return arguments.length?(this._model!==a&&(this._model=a,this._handler&&this._handler.model(a)),this):this._model},n.data=function(a){var b=this.model();return arguments.length?(k.keys(a).forEach(function(c){b.data(c).add(k.duplicate(a[c]))}),this):b.data()},n.width=function(a){return arguments.length?(this.__width!==a&&(this._width=this.__width=a,this._el&&this.initialize(this._el.parentNode),this._strict&&(this._autopad=1)),this):this.__width},n.height=function(a){return arguments.length?(this.__height!==a&&(this._height=this.__height=a,this._el&&this.initialize(this._el.parentNode),this._strict&&(this._autopad=1)),this):this.__height},n.padding=function(a){return arguments.length?(this._padding!==a&&(k.isString(a)?(this._autopad=1,this._padding={top:0,left:0,bottom:0,right:0},this._strict="strict"===a):(this._autopad=0,this._padding=a,this._strict=!1),this._el&&(this._renderer.resize(this._width,this._height,a),this._handler.padding(a))),
this):this._padding},n.autopad=function(a){if(this._autopad<1)return this;this._autopad=0;var b=this._padding,c=this.model().scene().bounds,d=j.autopadInset,e=c.x1<0?Math.ceil(-c.x1)+d:0,f=c.y1<0?Math.ceil(-c.y1)+d:0,g=c.x2>this._width?Math.ceil(+c.x2-this._width)+d:0,c=c.y2>this._height?Math.ceil(+c.y2-this._height)+d:0;return b={left:e,top:f,right:g,bottom:c},this._strict?(this._autopad=0,this._padding=b,this._width=Math.max(0,this.__width-(e+g)),this._height=Math.max(0,this.__height-(f+c)),this._model.width(this._width),this._model.height(this._height),this._el&&this.initialize(this._el.parentNode),this.update()):this.padding(b).update(a),this},n.viewport=function(a){return arguments.length?(this._viewport!==a&&(this._viewport=a,this._el&&this.initialize(this._el.parentNode)),this):this._viewport},n.renderer=function(a){return arguments.length?("canvas"===a&&(a=g),"svg"===a&&(a=h),this._io!==a&&(this._io=a,this._renderer=null,this._el&&this.initialize(this._el.parentNode),this._build&&this.render()),this):this._io},n.initialize=function(a){var b,c=this,e=c._width,g=c._height,h=c._padding;return d.select(a).select("div.vega").remove(),this._el=a=d.select(a).append("div").attr("class","vega").style("position","relative").node(),c._viewport&&d.select(a).style("width",(c._viewport[0]||e)+"px").style("height",(c._viewport[1]||g)+"px").style("overflow","auto"),c._renderer=(c._renderer||new this._io.Renderer).initialize(a,e,g,h),b=c._handler,c._handler=(new this._io.Handler).initialize(a,h,c).model(c._model),b?b.handlers().forEach(function(a){c._handler.on(a.type,a.handler)}):f(this),this},n.update=function(a){a=a||{};var b=this,c=a.duration?new i(a.duration,a.ease):null,d=l.create();return c&&(d.trans=c),void 0!==a.reflow&&(d.reflow=a.reflow),b._build||(b._renderNode=new e(b._model.graph).router(!0),b._renderNode.evaluate=function(a){k.debug(a,["rendering"]);var c=b._model.scene();a.trans?a.trans.start(function(a){b._renderer.render(c,a)}):b._renderer.render(c);var d,e;for(d in a.data)e=b._model.data(d),e.revises()&&l.finalize(e.last());return a},b._model.scene(b._renderNode),b._build=!0),b._model.fire(d),b.autopad(a)},n.on=function(){return this._handler.on.apply(this._handler,arguments),this},n.off=function(){return this._handler.off.apply(this._handler,arguments),this},m.factory=function(a){return function(b){b=b||{};var c=a.defs(),d=(new m).model(a).width(c.width).height(c.height).padding(c.padding).renderer(b.renderer||"canvas");return b.el&&d.initialize(b.el),b.data&&d.data(b.data),d}},m}),f("parse/padding",["require","exports","module","../util/index"],function(a,b,c){var d=a("../util/index");return function(a){if(null==a)return"auto";if(d.isString(a))return"strict"===a?"strict":"auto";if(d.isObject(a))return a;var b=d.isNumber(a)?a:20;return{top:b,left:b,right:b,bottom:b}}}),f("parse/marks",["require","exports","module","./mark"],function(a,b,c){var d=a("./mark");return function(a,b,c,e){return{type:"group",width:c,height:e,scales:b.scales||[],axes:b.axes||[],marks:(b.marks||[]).map(function(b){return d(a,b)})}}}),f("parse/signals",["require","exports","module","./expr","../util/constants"],function(a,b,c){var d=a("./expr"),e=a("../util/constants");return function(a,b){var c=a.graph;return(b||[]).forEach(function(f){var g,h=c.signal(f.name,f.init);f.expr&&(g=d(c,f.expr),h.evaluate=function(e){var i=d.eval(c,g.fn,null,null,null,null,g.signals);return b.scale&&(i=a.scale(b,i)),h.value(i),e.signals[f.name]=1,e},h.dependency(e.SIGNALS,g.signals),g.signals.forEach(function(a){c.signal(a).addListener(h)}))}),b}}),f("parse/predicates",["require","exports","module","../util/index"],function(a,b,c){var d=a("../util/index");return function(a,b){function c(a,b){var c=d.field(a),e="signals["+c.map(d.str).join("][")+"]";return b[c.shift()]=1,e}function e(b){var e=[],f=[],g={},h={};return d.array(b).forEach(function(b,i){var j="o"+i,k="";if(void 0!==b.value)k=d.str(b.value);else if(b.arg)k="args["+d.str(b.arg)+"]";else if(b.signal)k=c(b.signal,g);else if(b.predicate){var l=a.predicate(b.predicate);l.signals.forEach(function(a){g[a]=1}),l.data.forEach(function(a){h[a]=1}),d.keys(b.input).forEach(function(a){var e=b.input[a];k+="args["+d.str(a)+"] = ",e.signal?k+=c(e.signal,g):e.arg&&(k+="args["+d.str(e.arg)+"]"),k+=", "}),k+="predicates["+d.str(b.predicate)+"](args, db, signals, predicates)"}e.push(j),f.push(j+"=("+k+")")}),{code:"var "+e.join(", ")+";\n"+f.join(";\n")+";\n",signals:d.keys(g),data:d.keys(h)}}function f(a){var b=e(a.operands);return"="==a.type&&(a.type="=="),{code:b.code+"return "+["o0","o1"].join(a.type)+";",signals:b.signals,data:b.data}}function g(a){for(var b=e(a.operands),c=[],d=0,f=a.operands.length;c.push("o"+d++)<f;);return"and"==a.type?a.type="&&":"or"==a.type&&(a.type="||"),{code:b.code+"return "+c.join(a.type)+";",signals:b.signals,data:b.data}}function h(a){var b=[a.item];a.range&&b.push.apply(b,a.range),a.scale&&b.push(a.scale);var c=e(b),f=c.code;if(a.data){var g=d.field(a.field).map(d.str);f+="var where = function(d) { return d["+g.join("][")+"] == o0 };\n",f+="return db["+d.str(a.data)+"].filter(where).length > 0;"}else a.range&&(a.scale&&(f+="o1 = o3(o1);\no2 = o3(o2);\n"),f+="return o1 < o2 ? o1 <= o0 && o0 <= o2 : o2 <= o0 && o0 <= o1");return{code:f,signals:c.signals,data:c.data.concat(a.data?[a.data]:[])}}var i={"=":f,"==":f,"!=":f,">":f,">=":f,"<":f,"<=":f,and:g,"&&":g,or:g,"||":g,"in":h};return(b||[]).forEach(function(b){var c=i[b.type](b),d=Function("args","db","signals","predicates",c.code);d.signals=c.signals,d.data=c.data,a.predicate(b.name,d)}),b}}),f("parse/interactors",["require","exports","module","../util/load","../util/index","../util/constants"],function(a,b,c){var d=a("../util/load"),e=a("../util/index"),f=a("../util/constants");return function(a,b,c){function g(a){return function(b,c){if(b)e.error("LOADING FAILED: "+a.url);else{var d=e.isObject(c)?c:JSON.parse(c);h(a.name,d)}0==--q&&i()}}function h(a,b){r={},s={},b.signals&&u.push.apply(u,l(a,b.signals)),b.predicates&&v.push.apply(v,m(a,b.predicates)),o(a,b.marks)}function i(){e.keys(t).length>0&&j(b.marks),b.signals=e.array(b.signals),b.predicates=e.array(b.predicates),b.signals.unshift.apply(b.signals,u),b.predicates.unshift.apply(b.predicates,v),c()}function j(a){var b,c,d,g;for(a=e.array(a),d=0,g=a.length;g>d;d++)b=a[d],(c=t[b.type])?(a[d]=e.duplicate(c),b.from&&(a[d].from=b.from),b.properties&&[f.ENTER,f.UPDATE,f.EXIT].forEach(function(f){a[d].properties[f]=e.extend(c.properties[f],b.properties[f])})):b.marks&&j(b.marks)}function k(a,b){return e.isString(b)?b+"_"+a:(e.keys(b).forEach(function(c){var d=new RegExp("\\b"+c+"\\b","g");a=a.replace(d,b[c])}),a)}function l(a,b){return b=e.array(b),b.forEach(function(b){b.name=r[b.name]=k(b.name,a)}),b.forEach(function(a){(a.streams||[]).forEach(function(a){a.type=k(a.type,r),a.expr=k(a.expr,r)})}),b}function m(a,b){return b=e.array(b),b.forEach(function(b){b.name=s[b.name]=k(b.name,a),[b.operands,b.range].forEach(function(a){(a||[]).forEach(function(a){a.signal?a.signal=k(a.signal,r):a.predicate&&n(a)})})}),b}function n(a){a.predicate=s[a.predicate],e.keys(a.input).forEach(function(b){var c=a.input[b];c.signal&&(c.signal=k(c.signal,r))})}function o(a,b){(b||[]).forEach(function(b){p(b.properties.enter),p(b.properties.update),p(b.properties.exit),t[k(b.name,a)]=b})}function p(a){e.keys(a).forEach(function(b){var c=a[b];c.signal?c.signal=k(c.signal,r):c.rule&&c.rule.forEach(function(a){a.signal&&(a.signal=k(a.signal,r)),a.predicate&&n(a)})})}var q=0,r={},s={},t={},u=[],v=[];return(b.interactors||[]).forEach(function(a){a.url&&(q+=1,d(a.url,g(a)))}),0===q&&setTimeout(i,1),b}}),f("parse/spec",["require","exports","module","../core/Model","../core/View","../parse/padding","../parse/marks","../parse/signals","../parse/predicates","../parse/data","../parse/interactors","../util/index"],function(a,b,c){var d=a("../core/Model"),e=a("../core/View"),f=a("../parse/padding"),g=a("../parse/marks"),h=a("../parse/signals"),i=a("../parse/predicates"),j=a("../parse/data"),k=a("../parse/interactors"),l=a("../util/index");return function(a,b,c){a=l.duplicate(a),c=c||e.factory;var m=a.width||500,n=a.height||500,o=a.viewport||null,p=new d;k(p,a,function(){p.defs({width:m,height:n,viewport:o,padding:f(a.padding),signals:h(p,a.signals),predicates:i(p,a.predicates),marks:g(p,a,m,n),data:j(p,a.data,function(){b(c(p))})})})}}),f("d3",[],function(){return a}),f("topojson",[],function(){return b}),{core:{View:e("core/View")},dataflow:{changeset:e("dataflow/changeset"),Datasource:e("dataflow/Datasource"),Graph:e("dataflow/Graph"),Node:e("dataflow/Node")},parse:{spec:e("parse/spec")},scene:{Builder:e("scene/Builder"),GroupBuilder:e("scene/GroupBuilder")},util:e("util/index"),config:e("util/config")}});